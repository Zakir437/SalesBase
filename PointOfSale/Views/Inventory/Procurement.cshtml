@{
    ViewBag.Title = "Procurement";
    Layout = "~/Views/Shared/_LayoutForTemplate.cshtml";
    long indentCount = ViewBag.IndentCount;
    long workOrderCount = ViewBag.WorkOrderCount;
    long minQtyProCount = ViewBag.minimumQtyProCount;
}
<style>
    .k-input {
        height: 26px !important;
    }
    p {
        margin: 10px;
    }
    hr{
        margin:0px;
    }
</style>
@*<section class="content-header">
    <ol class="breadcrumb">
        <li><a><i class="fa fa-shopping-cart"></i> Inventory</a></li>
        <li class="active"><a href="/Inventory/Procurement"><i class="fa fa-list-ul"></i> Procurement</a></li>
    </ol>
</section>*@
<section class="content">
    <div class="panel panel-info">
        <div class="panel-heading" style="padding-bottom:46px;">
            <div class="pull-left">
                <h4 class="uppercase">Procurement</h4>
            </div>
        </div>
        <p>
            <a class="btn btn-info" href="/Inventory/IndentHistory"><i class="fa fa-list-ul" aria-hidden="true"></i> Indent</a>
            @*<a class="btn btn-info" href="/Inventory/CreateWorkOrder"><i class="fa fa-list-ul"></i> Create Work-Order</a>*@
            <a class="btn btn-info" href="/Inventory/WorkOrder"><i class="fa fa-list-ul"></i> Work-Order</a>
            <a class="btn btn-info" href="/Inventory/IndentMRR"><i class="fa fa-list-ul"></i> MRR</a>
            <a class="btn btn-info" href="/Inventory/Waste"><i class="fa fa-list-ul"></i> Waste</a>
        </p>
        <hr />
        <div class="panel-heading">
            <ul class="nav nav-tabs StatusTab">
                <li class="active" id="liForProducts"><a href="#tab1ForProducts" data-toggle="tab">Products</a></li>
                <li  id="liForIndent"><a href="#tab2ForIndent" data-toggle="tab">Indent</a></li>
                <li id="liForWorkOrder"><a href="#tab3ForWorkOrder" data-toggle="tab">Work-Order</a></li>
                <li id="liForFullFillment"><a href="#tab4ForFullFillMent" data-toggle="tab">FullFillment</a></li>
            </ul>
        </div>
        <div class="panel-body" style="border:none!important;">
            <div class="row" style="margin:5px 0px;">
                <div id="divIndentMulti" class="pull-left" style="max-width: 48%!important; width:100%;">
                    @(Html.Kendo().MultiSelect()
                        .Name("IndentMultiselect")
                        .DataTextField("Text")
                        .DataValueField("Value")
                        .Placeholder("Type voucher name...")
                        .AutoBind(false)
                        .Events(e => e.Change("onChangeIndent"))
                        .HtmlAttributes(new { style = "width: 100%;" })
                        .DataSource(source =>
                        {
                            source.Read(read =>
                            {
                                read.Action("GetIndentVoucherList", "Inventory").Data("additionalInfo");
                            })
                            .ServerFiltering(false);
                        })
                    )
                    <span class="k-icon k-i-search" style="margin-top:-25px;float:right;margin-right:10px; position:relative">&nbsp;</span>
                </div>
                <div id="divWorkOrderMulti" class="pull-left" style="max-width: 48%!important; width:100%; display:none">
                    @(Html.Kendo().MultiSelect()
                        .Name("WorkOrderMultiselect")
                        .DataTextField("Text")
                        .DataValueField("Value")
                        .Placeholder("Type voucher name...")
                        .AutoBind(false)
                        .Events(e => e.Change("onChangeWorkOrder"))
                        .HtmlAttributes(new { style = "width: 100%;" })
                        .DataSource(source =>
                        {
                            source.Read(read =>
                            {
                                read.Action("GetWorkOrderVoucherList", "Inventory").Data("additionalInfoForWorkOrder"); ;
                            })
                            .ServerFiltering(false);
                        })
                    )
                    <span class="k-icon k-i-search" style="margin-top:-25px;float:right;margin-right:10px; position:relative">&nbsp;</span>
                </div>
               
            </div>
            <div class="tab-content">
                <div class="tab-pane fade in active" id="tab1ForProducts">
                    <div id="div_Products"></div>
                </div>
                <div  id="tab2ForIndent">
                    <div id="div_Indent"></div>
                </div>
                <div id="tab3ForWorkOrder">
                    <div id="div_WorkOrder"></div>
                </div>
                <div id="tab4ForFullFillMent">
                    <div id="div_FullFillMent"></div>
                </div>
            </div>
            <p class="text-center">
                <button class="btn btn-primary" id="btnSeeMore"><i class="fa fa-arrow-down"></i> See more</button>
            </p>
        </div>
    </div>
</section>
<script id="temp_win_voucher_send_to_workorder" type="text/x-kendo-template">
    <div style="padding:1em;">
        <p style="font-size: 14px; padding: 10px"> #=msg# </p>
        <div style="text-align: right;">
            <button type="button" class="k-button k-button-icontext k-primary k-grid-update" id="btn_indent_send_noty_ok"><span class="k-icon k-update"></span>OK</button>
            <button type="button" class="k-button k-button-icontext k-grid-cancel" id="btn_indent_send_noty_cancel"><span class="k-icon k-cancel"></span>Cancel</button>
        </div>
    </div>
</script>
<script>
    var id = 0, tab = 0, count = 10, selectedId = "";
    $(document).ready(function () {
        $("#liForInventory").addClass('active');
        $("#liForProcurement").addClass('active');
        $("#btnSeeMore").hide();

        $("#liForProducts").click();

        $("#divProcurementList").append('<div class="loading_partial"></div>');
        $("#divProcurementList").load('/Inventory/IndentList?isProcureList=true');
    });

    function clearBeforeClick() {
        count = 10;
        $("#div_Indent").empty();
        $("#div_WorkOrder").empty();
        $("#div_Products").empty();
        $("#div_FullFillMent").empty();

        $("#divIndentMulti").hide();
        $("#divWorkOrderMulti").hide();

        $("#btnSeeMore").hide();
    }
    //**************************************Product list***********************************
    $("#liForProducts").click(function () {
        tab = 1;
        clearBeforeClick();
        $("#div_Products").append('<div class="loading_partial"></div>');
        $("#div_Products").load('/Inventory/WorkOrderProductList?isListForProc=true');
    });
    //**************************************Indent List***********************************
    $("#liForIndent").click(function () {
        tab = 2;
        clearBeforeClick();
        if (@indentCount > count)
        {
            $("#btnSeeMore").show();
        }
        $("#divIndentMulti").show();
        $("#div_Indent").append('<div class="loading_partial"></div>');
        $("#div_Indent").load('/Inventory/IndentList?isProcureList=true&count=' + count);
    });
    //**************************************Work Order List***********************************
    $("#liForWorkOrder").click(function () {
        tab = 3;
        clearBeforeClick();
        if (@workOrderCount > count)
        {
            $("#btnSeeMore").show();
        }
        $("#divWorkOrderMulti").show();
        $("#div_WorkOrder").append('<div class="loading_partial"></div>');
        $("#div_WorkOrder").load('/Inventory/WorkOrderList?isListForProc=true&count=' + count);
    });
    //**************************************Fullfillment list***********************************
    $("#liForFullFillment").click(function () {
        tab = 4;
        clearBeforeClick();
        if (@minQtyProCount > count)
        {
            $("#btnSeeMore").show();
        }
        $("#div_FullFillMent").append('<div class="loading_partial"></div>');
        $("#div_FullFillMent").load('/Inventory/MinimumQuantityInfoList?count=' + count);
    });

    //***************************indent multiselect****************************
    function onChangeIndent()
    {
        selectedId = "";
        selectedId = this.value();
        $("#btnSeeMore").hide();
        if (selectedId.length > 0)
        {
            $("#div_Indent").empty();
            $("#div_Indent").append('<div class="loading_partial"></div>');
            $("#div_Indent").load('/Inventory/IndentList?selectedId=' + selectedId + '&isProcureList=true');
        }
        else
        {
            $("#liForIndent").click();
        }
    }
    function additionalInfo() {
        return {
            text: $.trim($("#IndentMultiselect").data("kendoMultiSelect").input.val())
        }
    }
    //**************************Work order multi select*****************
    function onChangeWorkOrder()
    {
        selectedId = "";
        selectedId = this.value();
        $("#btnSeeMore").hide();
        if (selectedId.length > 0)
        {
            $("#div_WorkOrder").empty();
            $("#div_WorkOrder").append('<div class="loading_partial"></div>');
            $("#div_WorkOrder").load('/Inventory/WorkOrderList?isListForProc=true&selectedId=' + selectedId);
        }
        else
        {
            $("#liForWorkOrder").click();
        }
    }

    function additionalInfoForWorkOrder()
    {
        return {

        }
    }

    //***************************Send to workorder****************************
    $("#div_Indent").on("click", ".btnSendToWorkOrder", function () {
        id = $(this).data("id");
        var kendoWindow = $("<div/>").kendoWindow({
            actions: ["Close"],
            title: "Alert",
            resizable: false,
            width: "30%",
            modal: true,
            close: onWindowClose
        });
        msg = "Are you sure want to send this voucher to work-order ?";
        var template = kendo.template($("#temp_win_voucher_send_to_workorder").html());
        kendoWindow.data("kendoWindow").content(template).center().open();
        document.documentElement.style.overflow = 'hidden';
        document.body.scroll = "no";

        kendoWindow.find("#btn_indent_send_noty_cancel").click(function () {
            kendoWindow.data("kendoWindow").close();
        }).end();

        kendoWindow.find("#btn_indent_send_noty_ok").click(function () {
            kendoWindow.data("kendoWindow").close();
            sendToWorkOrder(id);
        }).end();
    });

    function sendToWorkOrder(id) {
        //notification.show({ message: "Indent voucher is deleting...", showTime: startTime() }, "upload-progress");
        $.ajax({
            url: '@Url.Action("IndentVoucherStatusChange", "Inventory")',
            type: 'Post',
            data: { VoucherId: id, CreatedBy: userId, status: 2 }, // status 2 for change procurement status
            success: function (data) {
                //notification.hide(); notification.setOptions({ autoHideAfter: 5000 });
                if (data === "success") {

                    $("#liForIndent").click();

                    $('#IndentMultiselect').data('kendoMultiSelect').dataSource.read();
                    //$("#divProcurementList").empty();
                    //$("#divProcurementList").append('<div class="loading_partial"></div>');
                    //$("#divProcurementList").load('/Inventory/IndentList?isProcureList=true');

                    //notification.show({ message: "Indent voucher has been successfully deleted.", showTime: startTime() }, "upload-success");
                }
                else {
                    alert("Save error...");
                    //notification.show({ message: "Indent voucher deletion was unsuccessful", showTime: startTime() }, "upload-error");
                }
            }
        });
    };

    //******************************See more data***********************************
    $("#btnSeeMore").click(function () {
        count = count + 10;
        $(this).hide();
        if (tab == 1)
        {

        }
        else if (tab == 2)
        {
            if (@indentCount > count) {
                $(this).show();
            }
            $("#div_Indent").empty();
            $("#div_Indent").append('<div class="loading_partial"></div>');
            $("#div_Indent").load('/Inventory/IndentList?isProcureList=true&count=' + count);
        }
        else if (tab == 3)
        {
            if (@workOrderCount > count) {
                $("#btnSeeMore").show();
            }
            $("#div_WorkOrder").empty();
            $("#div_WorkOrder").append('<div class="loading_partial"></div>');
            $("#div_WorkOrder").load('/Inventory/WorkOrderList?isListForProc=true&count=' + count);
        }
        else if (tab == 4)
        {
            if (@minQtyProCount > count)
            {
                $("#btnSeeMore").show();
            }
            $("#div_FullFillMent").empty();
            $("#div_FullFillMent").append('<div class="loading_partial"></div>');
            $("#div_FullFillMent").load('/Inventory/MinimumQuantityInfoList?count=' + count);
        }
    });
</script>