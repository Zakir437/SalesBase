@using System.Globalization;
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutForTemplate.cshtml";
}
<link href="~/Content/numpad.css" rel="stylesheet" />
<link href="~/Content/myCss.css" rel="stylesheet" />
<link href="~/Content/Hover/hover.css" rel="stylesheet" />
<style>
    a{
        cursor:pointer;
    }
    .keypad{
        background:#eee;
        padding:10px 20% 35px 8%;
    }
    .selectedCartItem {
        background-color: #6d756926;
    }
    /*.itemCancel{
        color:red;
    }*/
    .border-top {
        border-top: 1px solid #a6a6a6;
    }
    .discountInfo{
        font-weight:400;
        font-size:14px;
    }
    .displayNone{
       display:none;
    }
    .blur{
        -webkit-filter: blur(2px);
    }
</style>
<section class="content">
    <div class="row" style="margin:0px;" id="divAll">
            <div class="col-md-8" id="divLeft">
                <div class="row" style="margin:0px;">
                    <div id="kendoAutoComplete">
                        <div class="col-md-4" style="padding: 0; padding-left:4px;">
                            <div id="divSearchStringText" style="display:none">
                                <input id="searchStringForText" style="width:100%; max-width:100%;" />
                            </div>
                            <div id="divSearchStringSKU">
                                <input id="searchStringForSKU" style="width:100%; max-width:100%" />
                            </div>
                            <div id="divSearchStringOrder" style="display:none">
                                <input id="searchStringOrder" style="width:100%; max-width:100%" />
                            </div>
                            <div id="divSearchStringAvailability" style="display:none">
                                <input id="searchStringAvailability" style="width:100%; max-width:100%" />
                            </div>
                            <div id="divSearchCoupon" style="display:none">
                                <input id="searchStringCoupon" style="width:100%; max-width:100%" />
                            </div>
                        </div>
                        <div class="pull-right">
                            <button type="button" class="btn btn-primary selected" id="btnSearchBySKU" data-toggle="tooltip" title="Search by barcode">Barcode</button>
                            <button type="button" class="btn btn-primary" id="btnSearchByText" data-toggle="tooltip" title="Search by product name">Text</button>
                            <button type="button" class="btn btn-primary" id="btnOrders" data-toggle="tooltip" title="Search order for refund">Orders</button>
                            <button type="button" class="btn btn-primary" id="btnAvailability" data-toggle="tooltip" title="Check product Availability">Availability</button>
                            <button type="button" class="btn btn-primary" id="btnCoupon" data-toggle="tooltip" title="Search coupon">Coupon</button>
                            <div class="btn-group">
                                <button class="btn btn-primary" id="btnGridView" data-toggle="tooltip" title="Grid View"><i class="fa fa-th-large"></i></button>
                                <button class="btn btn-primary" id="btnListView" data-toggle="tooltip" title="List View"><i class="fa fa-bars"></i></button>
                            </div>
                            @*<button class="btn btn-default" id="btnOffer" data-toggle="tooltip" title="View offer List">Offer</button>*@
                        </div>
                    </div>
                </div>
                <div class="row" style="margin:5px 0px 0px 0px; ">
                    <div id="divDebitAndCredit">
                        <div class="col-md-2 text-center img-thumbnail" id="btnAccountRefill" data-id="0" style="cursor:pointer; border: 1px solid #cccccc; margin: 5px; height:66px;">
                            <h4>Account Refill</h4>
                        </div>
                        <div class="col-md-2 text-center img-thumbnail" id="btnCreditPayment" data-id="0" style="cursor:pointer; border: 1px solid #cccccc; margin: 5px; height:66px;">
                            <h4>Credit Payment</h4>
                        </div>
                    </div>
                    <div id="productList"></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="row" id="" style="padding-bottom:5px;">
                    @(Html.Kendo().DropDownList()
                        .Name("CustomerDropdown")
                        .BindTo(ViewBag.CustomerList as SelectList)
                        .DataTextField("Text")
                        .DataValueField("Value")
                        .Filter("contains")
                        .OptionLabel("--Select one customer--")
                        .HtmlAttributes(new { style = "width:100%" })
                        .Events(e =>
                        {
                            e.Change("onChangeCustomer");
                        })
                    )
                </div>
                <div class="row" id="divPurchaseOrder" style="display:none; padding-bottom:5px">
                        @(Html.Kendo().DropDownList()
                        .Name("PurchaseOrderDropdown")
                        .DataTextField("Text")
                        .DataValueField("Value")
                        .Filter("contains")
                        .OptionLabel("--Select one purchase order--")
                        .HtmlAttributes(new { style = "width:100%" })
                        .DataSource(source =>
                        {
                            source.Read(read =>
                            {
                                read.Action("GetPurchaseOrderProducts", "Sales").Data("additionalDataForPurchaseOrder");
                            })
                            .ServerFiltering(false);
                        })
                        .Events(e =>
                        {
                            e.Change("onChangePurchaseOrder");
                        })
                        )
                </div>
                <div class="row">
                    <div class="box box-success">
                        <div id="OrderContainer">
                            <div id="orderTitleHolder" class="clearfix">
                                <h2 id="orderTitle">
                                    @*<span class="fa fa-shopping-cart"></span>*@
                                    Your Order
                                </h2>
                                <button class="btn pull-right" type="button" id="emptyCartBtn" data-toggle="tooltip" title="Clear">clear</button>
                                <button type="button" id="btnInvoiceInfo" class="btn pull-right" style="margin:0px 5px;" data-toggle="tooltip" title="Invoice Details"><i class="fa fa-info-circle"></i></button>
                                <button type="button" id="btnOfferFromCartItem" class="btn pull-right" data-toggle="tooltip" title="Offer Info"><i class="fa fa-percent"></i></button>
                                <a id="orderReload" class="pull-right" style="padding-right:10px; margin-top:4px; display:none" data-toggle="tooltip" title="Reload"><i class="fa fa-refresh" aria-hidden="true"></i></a>
                                <a id="btnPaymentInfo" class="pull-right" style="padding-right:10px; margin-top:4px; display:none" data-toggle="tooltip" title="Payment Info"><i class="fa fa-dollar" aria-hidden="true"></i></a>
                                <a id="btnRefundInfo" class="pull-right" style="padding-right:10px; margin-top:4px; display:none" data-toggle="tooltip" title="Refund Info"><i class="fa fa-reply" aria-hidden="true"></i></a>
                            </div>
                            <ul id="cartListContainer" class="orderLines" style="max-height:300px; overflow-y:scroll"></ul>
                            <div id="emptyCartPlaceholder"><i class="fa fa-shopping-cart"></i> Cart Is Empty.</div>
                            <div id="pricesWrap-sticky-wrapper" class="stricky-wrapper">
                                <div id="priceWrap">
                                    <div id="billSummaryContainer">
                                        <table class="summaryTbl">
                                            <tr id="orderAmountRow" class="displayNone">
                                                <td>Order Amount </td>
                                                <td><span id="divOrderAmountTotal">0.00</span>Tk</td>
                                            </tr>
                                            <tr id="divDiscItemRow" class="displayNone">
                                                <td>Discount Item</td>
                                                <td>-<span id="divDiscItemTotal">0.00</span>Tk</td>
                                            </tr>
                                            <tr id="divSubTotalRow" class="border-top displayNone">
                                                <td>
                                                    Sub Total <span id="divSubTotalBeforeDisc"></span>
                                                    <br />
                                                    <span class="discountInfo" id="tdDiscount"></span>
                                                    <span class="discountInfo" id="tdCouponDiscount"></span>
                                                </td>
                                                <td><span id="divSubTotal">0.00</span>Tk</td>
                                            </tr>
                                            <tr id="taxRateRow" class="displayNone">
                                                <td>Tax(<span id="divTaxPercent">@ViewBag.Tax</span>%)</td>
                                                <td><span id="taxAmount">0.00</span>Tk</td>
                                            </tr>
                                            <tr id="totalAmountRow" class="displayNone">
                                                <td>Total Amount</td>
                                                <td><span id="divTotalAmount">0.00</span>Tk</td>
                                            </tr>
                                            <tr id="deliveryChargeRow" class="displayNone">
                                                <td>
                                                    Delivery Charge(<span id="divDeliveryChargeAmount">0</span><span id="divdelChargeType"  data-delchargetype="0" data-deliveryid="0">%</span><span id="divDelChargeBeforeDisc"></span>)<br />
                                                    <span class="discountInfo" id="tdDelivChargeDisc"></span>
                                                    <span class="discountInfo" id="tdCouponDelivChargeDisc"></span>
                                                </td>
                                                <td><span id="divDeliveryCharge">0.00</span>Tk</td>
                                            </tr>

                                            <tr id="orderAmountMainRow">
                                                <td>Order Amount <span id="tdOrderAmountMainDiscountInfo" style="display:none">| <span id="orderAmountBeforeDisc">0.00</span>Tk | <span id="orderAmountDiscount">0.00</span>Tk</span></td>
                                                <td><span id="divOrderAmountMainTotal">0.00</span>Tk</td>
                                            </tr>
                                            <tr id="taxAmountMainRow">
                                                <td>Tax</td>
                                                <td><span id="taxAmountInMain">0.00</span>Tk</td>
                                            </tr>
                                            <tr id="deliveryChargeMainRow">
                                                <td>Delivery Charge</td>
                                                <td><span id="divDeliveryChargeInMain">0.00</span>Tk</td>
                                            </tr>

                                            <tr id="divInvoiceRow" class="border-top">
                                                <td>Invoice Amount</td>
                                                <td><span id="divInvoiceAmount">0.00</span>Tk</td>
                                            </tr>
                                        </table>
                                    </div>
                                    <div class="keypad" style="background:#eee">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
</section>
<div id="divUnitWiseWin"></div>
<div id="divAvailabilityWin"></div>
<div id="divCheckoutWin"></div>
<div id="divRefundInfoWin"></div>
<div id="divPaymentTranWin"></div>
<div id="divRefundPayWin"></div>
<div id="divGetOfferWin"></div>
<div id="divAccountRefillWin"></div>
<div id="divCreditPaymentWin"></div>
<div id="divDebitRefillWin"></div>
<div id="divAssociateWin"></div>
<div id="divProductSN"></div>
<div id="divInvoiceInfo"></div>
<script>
    var taxRate = parseInt('@ViewBag.Tax'), taxStatus = @ViewBag.TaxStatus, productId = 0, productName="", prePrice = 0, kendoAutoComplete = null, totalPrice = 0.00;
    var liSelectedId = 0, quantity = 0, previousQ = "", price = 0.00, discType = 0, disCount = 0, totalNumber = [];
    var discountAmount = 0.00, numpadFunction = 0, number = 0, itemPrice = 0, orderId = 0;
    var isUnitWise = "", isUniqueItem = "", subTotalPrice = 0, tax = 0, discPercent = 0, selectedValue = "";
    var clientId = 0, customerName = "", IsCreditAllow;
    var taxFunc = @ViewBag.TaxFunc;
    var taxIcon = "D"; // tax on discounted amount
    var orderProducts = [], id = 0, count = 0;
    //credit pay
    var duePay = 0, transactionType = 0;
    //Debit refill amount
    var debitRefill = 0;
    //if product borrow from another shop
    var associateId = 0, isBorrow = false;
    //service and points
    var isAfterSaleService = false, serviceDays = 0, serviceName = "", serviceTypeId = 0, isPointBased = false, points = 0;
    var isServiceItem = false, isPointItem = false, totalPoints = 0;
    //Product serial number
    var serialNumber = "", isUniqueitem = false;
    //refund item or change item
    var extraPay = 0;
    var distributeId = 0;
    var rowId = 0;
    var deliveryCharge = 0, IsDeliveryChargeAuto = @ViewBag.DeliveryChargeIsAuto, deliveryChargeDiscount = 0;
    var purchaseOrderId = 0, purchaseOrderQty = 0, poItemId = 0, poPrice = 0;
    var offerId = 0, coupon = "", couponAmount = "", couponType = 0;
    var invoiceDiscount = 0, orderAmount = 0, actualAmount = 0;

    $(document).ready(function () {

        $("#liForPos").addClass('active');

        $("#divDebitAndCredit").hide();
        if (taxFunc == 1) {
            taxIcon = "A"; // tax on actual amount
        }
        $('[data-toggle="tooltip"]').tooltip();
        $("#productList").empty();
        $("#productList").append('<div class="loading_partial"></div>');
        $("#productList").load('@Url.Action("ProductList","PointOfSale")');
        $(".keypad").empty();
        $(".keypad").load('/PointOfSale/Numpad?isDeliveryChargeAuto=' + IsDeliveryChargeAuto);

        //change liSelected value when click on cart list product
        $("#cartListContainer").on('click', 'li', function () {
            totalNumber = [];
            liSelectedId = $(this).data("id");
            discType = 0;
            $('#cartListContainer li').removeClass('selectedCartItem');
            $(this).addClass('selectedCartItem');

            //change discount type fixed/percent
            if ($("#discount_" + liSelectedId).length == 1) {
                discType = parseInt($("#discount_" + liSelectedId).data("disctype"));
                if (discType == 0) {
                    $(".keypad").ready(function () {
                        $("#discPercent").prop('checked', true);
                    });
                }
                else {
                    $(".keypad").ready(function () {
                        $("#discFixed").prop('checked', true);
                    });
                }
            }
            else
            {
                $(".keypad").ready(function () {
                    $("#discFixed").prop('checked', true);
                });
            }
        });
    });
    //deselect of selected product in cart list
    $('body').on('click', function (e) {
        if ($(e.target).closest('#OrderContainer').length == 0) {
            $('#cartListContainer li').removeClass('selectedCartItem');
             liSelectedId = 0;
             totalNumber = [];
             if ($("#discountRow").length == 1) {
                 discType = parseInt($("#discAmount").data("id"));
                 if (discType == 0) {
                     $(".keypad").ready(function () {
                         $("#discPercent").prop('checked', true);
                     });
                 } else {
                     $(".keypad").ready(function () {
                         $("#discFixed").prop('checked', true);
                     });
                 }
             }
        }
    });

    //***********************************calculate tax, discount*****************************************
    function calculateCartAmount(discountAfferCoupon)
    {
        totalPrice = 0.00;
        orderAmount = 0;
        invoiceDiscount = 0;
        discountAmount = 0;
        $(".subitemPrice").each(function () {
            id = parseInt($(this).data("id"));
            quantity = 1;
            if (parseFloat($("#odrQuantity_" + id).text()) > 0)
            {
                quantity = parseFloat($("#odrQuantity_" + id).text());
            }
            price = parseFloat($(this).data("price"));
            price = price * quantity;
            orderAmount = orderAmount + price;
            totalPrice = totalPrice + parseFloat($(this).text());
        });

        $("#orderAmountBeforeDisc").empty();
        $("#orderAmountDiscount").empty();
        $("#divOrderAmountMainTotal").empty();

        if (orderAmount > totalPrice)
        {
            invoiceDiscount = orderAmount - totalPrice;
            $("#tdOrderAmountMainDiscountInfo").show();
            $("#orderAmountBeforeDisc").append(orderAmount.toFixed(2));
            $("#orderAmountDiscount").append(invoiceDiscount.toFixed(2));

            $("#divOrderAmountMainTotal").append(totalPrice.toFixed(2));
        }
        else
        {
            $("#tdOrderAmountMainDiscountInfo").hide();
            $("#orderAmountBeforeDisc").append(0.00);
            $("#orderAmountDiscount").append(0.00);
            $("#divOrderAmountMainTotal").append(orderAmount.toFixed(2));
        }
        $("#divDiscItemTotal").empty();
        $("#divDiscItemTotal").append(invoiceDiscount.toFixed(2));

        $("#divSubTotal").empty();
        $("#divSubTotal").append(totalPrice.toFixed(2));

        $("#divOrderAmountTotal").empty();
        $("#divOrderAmountTotal").append(orderAmount.toFixed(2));

        actualAmount = orderAmount;
        if (totalPrice > 0)
        {
            if (orderId > 0)
            {
                //$("#btnRefundPay").removeClass('disabled');
                //$("#btnPrint").removeClass('disabled');

                // if tax on actual amount
                if (orderTaxRate > 0 && orderTaxFunc == 1) // taxfunc 1 for tax on actual amount
                {
                    tax = totalPrice * (orderTaxRate / 100);
                    totalPrice = totalPrice + tax;
                    $("#taxAmount").empty();
                    $("#taxAmount").append(tax.toFixed(2));
                }
                //discount change
                if ($("#discountRow").length == 1) {
                    discType = parseInt($("#discountRow").data("disctype"));
                    discountAmount = totalPrice * (orderDisPercentage / 100);
                    totalPrice = totalPrice - discountAmount;
                    if (discType == 1) {
                        $("#discAmount").empty();
                        $("#discAmount").append(discountAmount.toFixed(2));
                    }
                    else {
                        $("#discUnit").empty();
                        $("#discUnit").append('%(' + discountAmount.toFixed(2) + 'Tk)');
                    }
                    $("#totalAmount").empty();
                    $("#totalAmount").append(totalPrice.toFixed(2));
                }
                //tax change
                if (orderTaxRate > 0) {
                    if (orderTaxFunc == 0) // 0 for tax on discounted amount
                    {
                        tax = totalPrice * (orderTaxRate / 100);
                        totalPrice = totalPrice + tax;
                        $("#taxAmount").empty();
                        $("#taxAmount").append(tax.toFixed(2));
                    }
                    $("#totalAmount").empty();
                    $("#totalAmount").append(totalPrice.toFixed(2));
                }

                $("#btnRefundPay").removeClass('disabled');
                $("#btnPrint").removeClass('disabled');

                if (orderTotalPrice >= totalPrice)
                {
                    extraPay = 0;
                    $("#divExtraPayRow").remove();

                    refundAmount = orderTotalPrice - totalPrice;
                    if (refundAmount == 0)
                    {
                        $("#divrefundRow").remove();
                    }
                    else
                    {
                        if ($("#divrefundRow").length == 1) {
                            $("#divRefundAmount").empty();
                            $("#divRefundAmount").append(refundAmount.toFixed(2));
                        }
                        else {
                            $(".summaryTbl").append(' <tr class="totalCartPriceRow" id="divrefundRow">' +
                                '<td>Refund Amount</td>' +
                                '<td id="total">' +
                                '<div>' +
                                '<span id="divRefundAmount">' + refundAmount.toFixed(2) + '</span>Tk' +
                                '</div>' +
                                '</td>' +
                                '</tr >');
                        }
                    }
                }
                else
                {
                    refundAmount = 0;
                    $("#divrefundRow").remove();
                    extraPay = totalPrice - orderTotalPrice;
                    if ($("#divExtraPayRow").length == 1) {
                        $("#divPayamount").empty();
                        $("#divPayamount").append(extraPay.toFixed(2));
                    }
                    else {
                        $(".summaryTbl").append(' <tr id="divExtraPayRow">' +
                            '<td>Pay amount</td>' +
                            '<td id="total">' +
                            '<div>' +
                            '<span id="divPayamount">' + extraPay.toFixed(2) + '</span>Tk' +
                            '</div>' +
                            '</td>' +
                            '</tr >');
                    }
                }
            }
            else
            {
                //if customer due pay by credit payment
                if (duePay > 0) {
                    orderAmount = orderAmount - duePay;
                }
                //if debit account refill
                if (debitRefill > 0) {
                    orderAmount = orderAmount - debitRefill;
                }
                totalPrice = orderAmount;
                if (invoiceDiscount > 0)
                {
                    totalPrice = totalPrice - invoiceDiscount;
                }

                //*************check amount discount***********************
                if (totalPrice > 0 && discountAfferCoupon == undefined) {

                    if (parseInt($("#divDiscountAmount").data("offertype")) == 1) //if manual discount exist
                    {
                        disCount = parseInt($("#divDiscountAmount").text());
                        discType = parseInt($("#divDiscountAmount").data("disctype"));
                        if (discType == 1) //static
                        {
                            discountAmount = disCount;
                        }
                        else //percentile
                        {
                            discountAmount = totalPrice * (disCount / 100);
                            $("#divDiscValue").empty();
                            $("#divDiscValue").append(discountAmount.toFixed(2));
                        }
                        if (invoiceDiscount > 0)
                        {
                            if (discountAmount > invoiceDiscount)
                            {
                                discountAmount = discountAmount - invoiceDiscount;
                            }
                            else
                            {
                                discountAmount = 0;
                            }
                        }
                        totalPrice = totalPrice - discountAmount;
                        $("#divInvoiceDiscount").empty();
                        $("#divInvoiceDiscount").append(discountAmount.toFixed());

                        //if customer due pay by credit payment
                        if (duePay > 0) {
                            totalPrice = totalPrice + duePay;
                        }
                        //if debit account refill
                        if (debitRefill > 0) {
                            totalPrice = totalPrice + debitRefill;
                        }
                        $("#divSubTotal").empty();
                        $("#divSubTotal").append(totalPrice.toFixed(2));

                        $("#subTotalBeforeDisc").empty();
                        $("#subTotalBeforeDisc").append((totalPrice + discountAmount).toFixed(2));

                        //if customer due pay by credit payment
                        if (duePay > 0) {
                            totalPrice = totalPrice - duePay;
                        }
                        //if debit account refill
                        if (debitRefill > 0) {
                            totalPrice = totalPrice - debitRefill;
                        }
                    }
                    else
                    {
                        $("#tdDiscount").empty();
                        $("#divSubTotalBeforeDisc").empty();
                        $.ajax({
                            url: '/PointOfSale/CheckAmountDiscount',
                            type: 'GET',
                            data: { totalPrice: totalPrice },
                            async: false,
                            success: function (data) {
                                if (data == "error") {
                                    alert("Amount discount Check error.");
                                }
                                else if (data == "notFound") {
                                    $("#tdDiscount").empty();
                                }
                                else {
                                    $("#divSubTotalBeforeDisc").append(
                                        '(<span id="subTotalBeforeDisc">' + totalPrice.toFixed(2) + '</span>Tk)'
                                    );
                                    discountAmount = data.invoiceDiscount;
                                    if (invoiceDiscount > 0) {
                                        if (discountAmount > invoiceDiscount) {
                                            discountAmount = discountAmount - invoiceDiscount;
                                            totalPrice = totalPrice - discountAmount;
                                        }
                                        else {
                                            discountAmount = 0;
                                        }
                                    }
                                    else {
                                        totalPrice = totalPrice - discountAmount;
                                    }

                                    if (data.IsPercentile) {
                                        $("#tdDiscount").append(
                                            'Discount Amount(<span id="divDiscountAmount" data-disctype="0" data-offertype="2" data-offerid="' + data.Id + '">' + data.Amount + '</span>%) | <span id="divDiscValue">' + data.invoiceDiscount + '</span>Tk  | -<span id="divInvoiceDiscount">' + discountAmount.toFixed(2) + '</span>Tk'
                                        );
                                    }
                                    else {
                                        $("#tdDiscount").append(
                                            'Discount Amount(<span id="divDiscountAmount" data-disctype="1" data-offertype="2" data-offerid="' + data.Id + '">' + data.Amount + '</span>Tk) | <span id="divDiscValue">' + data.invoiceDiscount + '</span>Tk  | -<span id="divInvoiceDiscount">' + discountAmount.toFixed(2) + '</span>Tk'
                                        );
                                    }

                                    //if customer due pay by credit payment
                                    if (duePay > 0) {
                                        totalPrice = totalPrice + duePay;
                                    }
                                    //if debit account refill
                                    if (debitRefill > 0) {
                                        totalPrice = totalPrice + debitRefill;
                                    }

                                    $("#divSubTotal").empty();
                                    $("#divSubTotal").append(totalPrice.toFixed(2));

                                    //if customer due pay by credit payment
                                    if (duePay > 0) {
                                        totalPrice = totalPrice - duePay;
                                    }
                                    //if debit account refill
                                    if (debitRefill > 0) {
                                        totalPrice = totalPrice - debitRefill;
                                    }
                                }
                            }
                        });
                    }
                }
                if (discountAfferCoupon > 0) {
                    //if customer due pay by credit payment
                    if (duePay > 0) {
                        totalPrice = totalPrice + duePay;
                    }
                    //if debit account refill
                    if (debitRefill > 0) {
                        totalPrice = totalPrice + debitRefill;
                    }

                    $("#subTotalBeforeDisc").empty();
                    $("#subTotalBeforeDisc").append(totalPrice.toFixed(2));

                    totalPrice = totalPrice - discountAfferCoupon;

                    $("#divSubTotal").empty();
                    $("#divSubTotal").append(totalPrice.toFixed(2));

                    //if customer due pay by credit payment
                    if (duePay > 0) {
                        totalPrice = totalPrice - duePay;
                    }
                    //if debit account refill
                    if (debitRefill > 0) {
                        totalPrice = totalPrice - debitRefill;
                    }
                }
                // if tax on actual amount
                if (taxStatus == 1 && taxFunc == 1) // taxfunc 1 for tax on actual amount
                {
                    tax = orderAmount * (taxRate / 100);
                    totalPrice = totalPrice + tax;
                }
                // Tax change
                if (taxStatus == 1)
                {
                    if (taxFunc == 0) // 0 for tax on discounted amount
                    {
                        tax = totalPrice * (taxRate / 100);
                        totalPrice = totalPrice + tax;
                        $("#taxAmount").empty();
                        $("#taxAmount").append(tax.toFixed(2));
                    }
                    //if customer due pay by credit payment
                    if (duePay > 0) {
                        totalPrice = totalPrice + duePay;
                    }
                    //if debit account refill
                    if (debitRefill > 0) {
                        totalPrice = totalPrice + debitRefill;
                    }
                }

                //if customer due pay by credit payment
                if (duePay > 0) {
                    totalPrice = totalPrice + duePay;
                }
                //if debit account refill
                if (debitRefill > 0) {
                    totalPrice = totalPrice + debitRefill;
                }

                $("#divTotalAmount").empty();
                $("#divTotalAmount").append(totalPrice.toFixed(2));

                //if customer due pay by credit payment
                if (duePay > 0) {
                    totalPrice = totalPrice - duePay;
                }
                //if debit account refill
                if (debitRefill > 0) {
                    totalPrice = totalPrice - debitRefill;
                }

                //*********Delivery charge********************
                if ($("#deliveryChargeRow").length == 1 && IsDeliveryChargeAuto == 1)
                {
                    $("#divDelChargeBeforeDisc").empty();
                    $("#tdDelivChargeDisc").empty();
                    if (totalPrice > 0) {
                        $.ajax({
                            url: '/PointOfSale/CheckDeliveryCharge',
                            type: 'GET',
                            data: { totalPrice: parseFloat($("#divSubTotal").text()) },
                            async: false,
                            success: function (data) {
                                if (data == "error") {
                                    alert("Delivery charge Check error.");
                                    $("#divDeliveryChargeAmount").empty();
                                    $("#divDeliveryChargeAmount").append(0);
                                    $("#divdelChargeType").empty();
                                    $("#divdelChargeType").append('%');
                                    $("#divdelChargeType").attr('data-delchargetype', '0');
                                    $("#divdelChargeType").attr('data-deliveryid', '0');
                                    $("#divDeliveryCharge").empty();
                                    $("#divDeliveryCharge").append(0);
                                }
                                else
                                {
                                    totalPrice = totalPrice + data.deliveryCharge;
                                    if (data.IsPercentile) {

                                        $("#divDeliveryChargeAmount").empty();
                                        $("#divDeliveryChargeAmount").append(data.Amount);
                                        $("#divdelChargeType").empty();
                                        $("#divdelChargeType").append('%');
                                        $("#divdelChargeType").attr('data-delchargetype', '0');
                                        $("#divDeliveryCharge").empty();
                                        $("#divDeliveryCharge").append(data.deliveryCharge.toFixed(2));
                                    }
                                    else
                                    {
                                        $("#divDeliveryChargeAmount").empty();
                                        $("#divDeliveryChargeAmount").append(data.Amount);
                                        $("#divdelChargeType").empty();
                                        $("#divdelChargeType").append('Tk');
                                        $("#divdelChargeType").attr('data-delchargetype', '1');
                                        $("#divDeliveryCharge").empty();
                                        $("#divDeliveryCharge").append(data.deliveryCharge.toFixed(2));
                                    }
                                    $("#divdelChargeType").attr('data-deliveryid', data.DeliveryId);

                                    //*******************Delivery charge discount**********************
                                    if (data.discountDeliveryCharge > 0) {
                                        $("#divDelChargeBeforeDisc").append(
                                            ' | <span id="deliveryChargeBeforeDisc">' + data.deliveryCharge.toFixed(2) + '</span>Tk'
                                        );
                                        $("#tdDelivChargeDisc").append(
                                            'Discount(<span id="divDelChargeDiscPercent" data-offertype="2" data-offerid="' + data.delDiscId +'">' + data.discountDeliveryPercentage + '</span>%) | ' +
                                            '-<span id="divDelChargeDiscount">' + data.discountDeliveryCharge.toFixed(2) + '</span>Tk'
                                        );

                                        $("#divDeliveryCharge").empty();
                                        $("#divDeliveryCharge").append((data.deliveryCharge - data.discountDeliveryCharge).toFixed(2));
                                        totalPrice = totalPrice - data.discountDeliveryCharge;
                                    }
                                }
                            }
                        });
                    }
                    else {
                        alert("Cart is Empty...");
                    }
                }
                else if (IsDeliveryChargeAuto == 1)
                {
                    $("#divDelChargeBeforeDisc").empty();
                    $("#tdDelivChargeDisc").empty();
                    if (orderAmount > 0)
                    {
                        $.ajax({
                            url: '/PointOfSale/CheckDeliveryCharge',
                            type: 'GET',
                            data: { totalPrice: parseFloat($("#divSubTotal").text()) },
                            success: function (data) {
                                if (data == "error") {
                                    alert("Delivery charge Check error.");
                                    $("#divDeliveryChargeAmount").empty();
                                    $("#divDeliveryChargeAmount").append(0);
                                    $("#divdelChargeType").empty();
                                    $("#divdelChargeType").append('%');
                                    $("#divdelChargeType").attr('data-delchargetype', '0');
                                    $("#divdelChargeType").attr('data-deliveryid', '0');
                                    $("#divDeliveryCharge").empty();
                                    $("#divDeliveryCharge").append(0);
                                }
                                else
                                {
                                    totalPrice = totalPrice + data.deliveryCharge;

                                    if (data.IsPercentile) {

                                        $("#divDeliveryChargeAmount").empty();
                                        $("#divDeliveryChargeAmount").append(data.Amount);
                                        $("#divdelChargeType").empty();
                                        $("#divdelChargeType").append('Tk');
                                        $("#divdelChargeType").attr('data-delchargetype', '1');
                                        $("#divDeliveryCharge").empty();
                                        $("#divDeliveryCharge").append(data.deliveryCharge.toFixed(2));
                                    }
                                    else
                                    {
                                        $("#divDeliveryChargeAmount").empty();
                                        $("#divDeliveryChargeAmount").append(data.Amount);
                                        $("#divdelChargeType").empty();
                                        $("#divdelChargeType").append('Tk');
                                        $("#divdelChargeType").attr('data-delchargetype', '1');
                                        $("#divDeliveryCharge").empty();
                                        $("#divDeliveryCharge").append(data.deliveryCharge.toFixed(2));
                                    }
                                    $("#divdelChargeType").attr('data-deliveryid', data.DeliveryId);

                                    //*******************Discount delivery charge************************************
                                    if (data.discountDeliveryCharge > 0) {
                                        $("#divDelChargeBeforeDisc").append(
                                            ' | <span id="deliveryChargeBeforeDisc">' + data.deliveryCharge.toFixed(2) + '</span>Tk'
                                        );
                                        $("#tdDelivChargeDisc").append(
                                            'Discount(<span id="divDelChargeDiscPercent" data-offertype="2" data-offerid="' + data.delDiscId +'">' + data.discountDeliveryPercentage + '</span>%) | ' +
                                            '-<span id="divDelChargeDiscount">' + data.discountDeliveryCharge.toFixed(2) + '</span>Tk'
                                        );

                                        $("#divDeliveryCharge").empty();
                                        $("#divDeliveryCharge").append((data.deliveryCharge - data.discountDeliveryCharge).toFixed(2));
                                        totalPrice = totalPrice - data.discountDeliveryCharge;
                                    }
                                }
                            }
                        });
                    }
                }

                //if customer due pay by credit payment
                if (duePay > 0) {
                    totalPrice = totalPrice + duePay;
                }
                //if debit account refill
                if (debitRefill > 0) {
                    totalPrice = totalPrice + debitRefill;
                }

                $("#divInvoiceAmount").empty();
                $("#divInvoiceAmount").append(totalPrice.toFixed(2));
            }
        }
        else
        {
            $("#emptyCartBtn").click();
        }
        calculateOrderMainView();
    }

    function calculateOrderMainView()
    {
        $("#orderAmountBeforeDisc").empty();
        $("#orderAmountDiscount").empty();
        $("#divOrderAmountMainTotal").empty();
        $("#taxAmountInMain").empty();
        $("#divDeliveryChargeInMain").empty();

        orderAmount = parseFloat($("#divOrderAmountTotal").text());
        totalPrice = parseFloat($("#divSubTotal").text());
        if (orderAmount == 0) {
            $("#orderAmountBeforeDisc").append("0.00");
            $("#orderAmountDiscount").append("0.00");
            $("#divOrderAmountMainTotal").append("0.00");
            $("#taxAmountInMain").append("0.00");
            $("#divDeliveryChargeInMain").append("0.00");
        }
        else
        {
            invoiceDiscount = 0;
            tax = 0;
            deliveryCharge = 0;
            if (orderAmount > totalPrice) {
                invoiceDiscount = orderAmount - totalPrice;
                $("#tdOrderAmountMainDiscountInfo").show();
                $("#orderAmountBeforeDisc").append(orderAmount.toFixed(2));
                $("#orderAmountDiscount").append(invoiceDiscount.toFixed(2));
                $("#divOrderAmountMainTotal").append(totalPrice.toFixed(2));
            }
            else
            {
                $("#tdOrderAmountMainDiscountInfo").hide();
                $("#orderAmountBeforeDisc").append("0.00");
                $("#orderAmountDiscount").append("0.00");
                $("#divOrderAmountMainTotal").append(orderAmount.toFixed(2));
            }

            if ($("#taxAmount").length == 1) {
                tax = parseFloat($("#taxAmount").text());
            }

            $("#taxAmountInMain").append(tax.toFixed(2));

            if ($("#divDeliveryCharge").length == 1) {
                deliveryCharge = parseFloat($("#divDeliveryCharge").text());
            }

            $("#divDeliveryChargeInMain").append(deliveryCharge.toFixed(2));
        }
    }

    //*****************************add product to card**************************************
    function addProduct(productId, distId, purchaseQty)
    {
        id = 0;
        if ($("#pro_" + productId).length == 1)
        {
            if (distId > 0)
            {
                if ($("#dist_" + distId).length == 1)
                {
                    id = parseInt($("#dist_" + distId).data("id"));
                }
            }
            else
            {
                id = parseInt($("#pro_" + productId).data("id"));
            }
        }
        if (id > 0 && $("#cartItem_" + id).data("isuniqueitem") == false)
        {
            isUnitWise = $("#cartItem_" + id).data("isunitwise");
            if (isUnitWise == "True")
            {
                alert("You can't add more this product to cart");
                return false;
            }
            previousQ = $("#odrQuantity_" + id).text();

            if (purchaseQty > 0 && previousQ >= purchaseQty)
            {
                alert("Quantity can not be greater than " + purchaseQty);
                return false;
            }

            quantity = parseInt(previousQ) + 1;
            $("#odrQuantity_" + id).empty();
            $("#odrQuantity_" + id).append(quantity);
            itemPrice = parseFloat($("#perItemPrice_" + id).text());
            price = quantity * itemPrice;

            //per item discount change
            if ($("#discPerUnit_" + id).length == 1) {

                if ($('#divPerItemTotalPrice_' + id).length > 0) {
                    $("#divPerItemTotalPrice_" + id).empty();
                    $("#divPerItemTotalPrice_" + id).append(price.toFixed(2));
                }
                else {
                    $("#divPerItemTotal_" + id).append(' <span id="divPerItemTotalPrice_' + id + '">' + price.toFixed(2) + '</span> Tk</span> | ');
                }
                disCount = parseInt($("#discount_" + id).text());
                discType = parseInt($("#discount_" + id).data("disctype"));
                if (discType == 1) {
                    discountAmount = disCount * quantity;
                    price = price - disCount;
                }
                else
                {
                    discountAmount = price * (disCount / 100);
                    price = price - discountAmount;
                }
                $("#discPerUnit_" + id).empty();
                $("#discPerUnit_" + id).append(discountAmount.toFixed(2));
            }
            $("#price_" + id).empty();
            $("#price_" + id).append(price.toFixed(2));

            if ($("#points_" + id).length == 1)
            {
                points = parseInt($("#points_" + id).data("points"));
                points = quantity * points;
                $("#points_" + id).empty();
                $("#points_" + id).append(points);
            }
            calculateCartAmount();
        }
         else
         {
            $.ajax({
                url: '@Url.Action("GetProduct", "PointOfSale")',
                type: "GET",
                data: { productId: productId, distributeId: distId },
                success: function (data) {
                    $(data).each(function (index, item) {
                        if (item.IsUnitWise == true)
                        {
                            $("#divProductSN").empty();
                            $("#divUnitWiseWin").empty();
                            $("#divUnitWiseWin").kendoWindow({
                                actions: ["Close"],
                                draggable: false,
                                modal: true,
                                visible: false,
                                width: 578,
                                height:470,
                                title: 'Unit Wise',
                                resizable: false
                            });
                            var unitWiseWin = $("#divUnitWiseWin").data("kendoWindow");
                            unitWiseWin.refresh('@Url.Action("Unitwise", "PointOfSale")?productId=' + productId);
                            unitWiseWin.center().open();
                        }
                        else
                        if(item.IsUniqueItem == true)
                        {
                            $("#divUnitWiseWin").empty();
                            $("#divProductSN").empty();
                            $("#divProductSN").kendoWindow({
                                actions: ["Close"],
                                draggable: false,
                                modal: true,
                                visible: false,
                                width: 744,
                                height:183,
                                title: 'Serial Number',
                                resizable: false
                            });
                            var proSNWin = $("#divProductSN").data("kendoWindow");
                            proSNWin.refresh('@Url.Action("SerialNumber", "PointOfSale")?productId=' + productId);
                            proSNWin.center().open();
                        }
                        else
                        {
                            count++;
                            if(poPrice > 0)
                            {
                                item.Price = poPrice;
                            }

                            $("#emptyCartPlaceholder").hide();

                            if (item.OfferPrice > 0)
                            {
                                $("#cartListContainer").prepend('<li class="singleCartItem" id="cartItem_' + count + '" data-id="' + count + '" data-poitemid="' + poItemId + '" data-productid="' + productId + '" data-distributeid="' + item.DistributeId + '" data-isrefundallow="' + item.IsRefundAllow + '" data-productname="' + item.ProductName + '" data-isuniqueitem="' + item.IsUniqueItem + '">' +
                                    '<span id="pro_' + productId + '" data-distributeid="' + item.DistributeId + '" data-id="' + count + '" style="font-size:13px; font-weight:bold;">' +
                                    '<span id="dist_' + item.DistributeId + '" data-id="' + count + '"></span>' + item.ProductName +
                                    '</span> | ' +
                                    ' <span class="decrease totalPriceUpdate" title="Reduce (-1)" data-id="' + count + '" data-price="' + item.Price + '">' +
                                    '<span class="fa fa-minus"></span>' +
                                    '</span> ' +
                                    ' <span class="odrQuantity" title="Quantity" id="odrQuantity_' + count + '">1</span>' +
                                    '<span class="increase totalPriceUpdate" title="Add (+1)" data-id="' + productId + '" data-distributeid="' + item.DistributeId + '"  data-price="' + item.Price + '" data-purchaseqty="' + purchaseOrderQty + '"  id="increaseBtn_' + count + '">'
                                    + '<span class="fa fa-plus"></span>' +
                                    ' </span> | ' +
                                    '<span id="divPerItemPrice_' + count + '">' +
                                    '<span id="perItemPrice_' + count + '" data-ispricechangeallow="' + item.IsPriceChangeAllow + '" data-isdiscountallow="' + item.IsDiscountAllow + '">' + item.Price + '</span >Tk | ' +
                                    '<span id="divPerItemTotal_' + count + '"></span>' +
                                    '<span id="price_' + count + '" data-id="' + count + '" data-price = "' + item.Price + '" class="subitemPrice" data-isdiscountallow="' + item.IsDiscountAllow + '">' + item.OfferPrice + '</span> Tk' +
                                    '</span>' +
                                    '<span class="pull-right" >' +
                                    '<input type="checkbox" class="checkBorrow" id="checkBorrow_' + count + '" data-id="' + count + '" data-associateid="0" />' +
                                    ' <span class="fa fa-times-circle itemCancel" data-id="' + count + '"></span>' +
                                    '</span> ' +
                                    '<br />' +
                                    '<span id="discPerItem_' + count + '">Discount(<span id="discount_' + count + '" data-disctype="0" data-offertype="2" data-offerid="' + item.OfferId +'">' + item.PercentageOff + '</span>%) | -<span id="discPerUnit_' + count + '">' + item.AmountOff + '</span>Tk</span></span>' +
                                    '<span id="discCouponPerItem_' + count + '"></span>' +
                                    (item.IsAfterSaleService == true ? item.ServiceName + '(<span id="service_' + count + '" data-servicename="' + item.ServiceName + '" data-servicetypeid = "' + item.ServiceTypeId + '">' + item.ServiceDays + '</span>days)' : "") +
                                    '<span class="pull-right">' + (item.IsPointBased == true ? 'Points(<span id="points_' + count + '" data-points="' + item.Points + '">' + item.Points + '</span>)' : "") + '</span>' +
                                    '</li>');
                            }
                            else
                            {
                                $("#cartListContainer").prepend('<li class="singleCartItem" id="cartItem_' + count + '" data-id="' + count + '" data-poitemid="' + poItemId + '" data-productid="' + productId + '" data-distributeid="' + item.DistributeId + '" data-isrefundallow="' + item.IsRefundAllow + '" data-productname="' + item.ProductName + '" data-isuniqueitem="' + item.IsUniqueItem + '">' +
                                    '<span id="pro_' + productId + '" data-distributeid="' + item.DistributeId + '" data-id="' + count + '" style="font-size:13px; font-weight:bold;">' +
                                    '<span id="dist_' + item.DistributeId + '" data-id="' + count + '"></span>' + item.ProductName +
                                    '</span> | ' +
                                    ' <span class="decrease totalPriceUpdate" title="Reduce (-1)" data-id="' + count + '" data-price="' + item.Price + '">' +
                                    '<span class="fa fa-minus"></span>' +
                                    '</span> ' +
                                    ' <span class="odrQuantity" title="Quantity" id="odrQuantity_' + count + '">1</span>' +
                                    '<span class="increase totalPriceUpdate" title="Add (+1)" data-id="' + productId + '" data-distributeid="' + item.DistributeId + '"  data-price="' + item.Price + '" data-purchaseqty="' + purchaseOrderQty + '"  id="increaseBtn_' + count + '">'
                                    + '<span class="fa fa-plus"></span>' +
                                    ' </span> | ' +
                                    '<span id="divPerItemPrice_' + count + '">' +
                                    '<span id="perItemPrice_' + count + '" data-ispricechangeallow="' + item.IsPriceChangeAllow + '" data-isdiscountallow="' + item.IsDiscountAllow + '">' + item.Price + '</span >Tk | ' +
                                    '<span id="divPerItemTotal_' + count + '"></span>' +
                                    '<span id="price_' + count + '" data-id="' + count + '" data-price = "' + item.Price + '" class="subitemPrice" data-isdiscountallow="' + item.IsDiscountAllow + '">' + item.Price + '</span> Tk' +
                                    '</span>' +
                                    '<span class="pull-right" >' +
                                    '<input type="checkbox" class="checkBorrow" id="checkBorrow_' + count + '" data-id="' + count + '" data-associateid="0" />' +
                                    ' <span class="fa fa-times-circle itemCancel" data-id="' + count + '"></span>' +
                                    '</span> ' +
                                    '<br />' +
                                    '<span id="discPerItem_' + count + '"></span>' +
                                    '<span id="discCouponPerItem_' + count + '"></span>' +
                                    (item.IsAfterSaleService == true ? item.ServiceName + '(<span id="service_' + count + '" data-servicename="' + item.ServiceName + '" data-servicetypeid = "' + item.ServiceTypeId + '">' + item.ServiceDays + '</span>days)' : "") +
                                    '<span class="pull-right">' + (item.IsPointBased == true ? 'Points(<span id="points_' + count + '" data-points="' + item.Points + '">' + item.Points + '</span>)' : "") + '</span>' +
                                    '</li>');
                            }
                        }
                        calculateCartAmount();
                        poItemId = 0;
                        purchaseOrderQty = 0;
                        poPrice = 0;
                    });
                }
            });
        }
    }


    // *************************add product to cart list from product list**************************
    $("#productList").on('click', "#addProduct", function () {
        poItemId = parseInt($(this).data("poitemid"));
        poPrice = parseInt($(this).data("poprice"));
        purchaseOrderQty = parseInt($(this).data("purchaseorderqty"));
        productId = parseInt($(this).data("id"));
        distributeId = parseInt($(this).data("distributeid"));
        isUnitWise = $(this).data("isunitwise");
        isUniqueItem = $(this).data("isuniqueitem");
        if (isUnitWise == "True")
        {
            if ($("#pro_" + productId).length == 1)
            {
                alert("You can't add more this product to cart");
                return false;
            }
            else
            {
                $("#divProductSN").empty();
                $("#divUnitWiseWin").empty();
                $("#divUnitWiseWin").kendoWindow({
                    actions: ["Close"],
                    draggable: false,
                    modal: true,
                    visible: false,
                    width: 578,
                    height:470,
                    title: 'Unit Wise',
                    resizable: false
                });
                var unitWiseWin = $("#divUnitWiseWin").data("kendoWindow");
                unitWiseWin.refresh('@Url.Action("Unitwise", "PointOfSale")?productId=' + productId);
                unitWiseWin.center().open();
            }
        }
        else
        if (isUniqueItem == "True")
        {
            $("#divUnitWiseWin").empty();
            $("#divProductSN").empty();
            $("#divProductSN").kendoWindow({
                actions: ["Close"],
                draggable: false,
                modal: true,
                visible: false,
                width: 744,
                height:183,
                title: 'Serial Number',
                resizable: false
            });
            var proSNWin = $("#divProductSN").data("kendoWindow");
            proSNWin.refresh('@Url.Action("SerialNumber", "PointOfSale")?productId=' + productId);
            proSNWin.center().open();
        }
        else
        {
            addProduct(productId, distributeId, purchaseOrderQty);
        }
    });

    //************************************Product quantity increase***********************************************
    $("#cartListContainer").on("click", ".increase", function () {
        productId = parseInt($(this).data("id"));
        distributeId = parseInt($(this).data("distributeid"));
        purchaseOrderQty = parseInt($(this).data("purchaseqty"));
        if (productId > 0)
        {
            addProduct(productId, distributeId, purchaseOrderQty);
        }
    });

    //**************************************Product quantity decrease*****************************
    $("#cartListContainer").on("click", ".decrease", function () {
        //check isrefundallow when refund
        if ($(this).data("isrefundallow") == "False") {
            alert("Sorry...This product can't refund");
            return false;
        }

        id = parseInt($(this).data("id"));
        price = parseFloat($("#perItemPrice_" + id).text()).toFixed(2);
        previousQ = $("#odrQuantity_" + id).text();
        quantity = parseInt(previousQ) - 1;
        if (quantity == 0)
        {
            $("#cartItem_" + id).remove();
        }
        else
        {
            $("#odrQuantity_" + id).empty();
            $("#odrQuantity_" + id).append(quantity);
            price = price * quantity;
            //per item discount change
            if ($("#discPerUnit_" + id).length == 1) {

                if (quantity > 1) {
                    if ($("#divPerItemTotalPrice_" + id).length > 0) {
                        $("#divPerItemTotalPrice_" + id).empty();
                        $("#divPerItemTotalPrice_" + id).append(price.toFixed(2));
                    }
                }
                else {
                    $("#divPerItemTotal_" + id).empty();
                }

                disCount = parseInt($("#discount_" + id).text());
                discType = parseInt($("#discount_" + id).data("disctype"));
                if (orderId > 0) {
                    if (discType == 1) {
                        discountAmount = quantity * disCount;
                        price = price - discountAmount;
                    }
                    else
                    {
                        discountAmount = price * (disCount / 100);
                        price = price - discountAmount;
                    }
                    $("#discPerUnit_" + id).empty();
                    $("#discPerUnit_" + id).append(discountAmount.toFixed(2));
                }
                else
                {
                    if (discType == 1) //discount fixed
                    {
                        discountAmount = quantity * disCount;
                        price = price - discountAmount;
                    }
                    else //discount percent
                    {
                        discountAmount = price * (disCount / 100);
                        price = price - discountAmount;
                    }
                    $("#discPerUnit_" + id).empty();
                    $("#discPerUnit_" + id).append(discountAmount.toFixed(2));
                }
            }
            $("#price_" + id).empty();
            $("#price_" + id).append(price.toFixed(2));

            if ($("#points_" + id).length == 1) {
                points = parseInt($("#points_" + id).data("points"));
                points = quantity * points;
                $("#points_" + id).empty();
                $("#points_" + id).append(points);
            }
        }
        calculateCartAmount();
    });


    function resetCart()
    {
        $(".summaryTbl").empty();
        $(".summaryTbl").append(
             '<tr id="orderAmountRow" class="displayNone">' +
                '<td>Order Amount </td>' +
                '<td><span id="divOrderAmountTotal">0.00</span>Tk</td>' +
            '</tr>' +
            '<tr id="divDiscItemRow" class="displayNone">' +
                '<td>Discount Item</td>' +
                '<td>-<span id="divDiscItemTotal">0.00</span>Tk</td>' +
            '</tr>' +
            '<tr id="divSubTotalRow" class="border-top displayNone">' +
                '<td>' +
                'Sub Total <span id="divSubTotalBeforeDisc"></span>' +
                '<br /><span class="discountInfo" id="tdDiscount"></span>' +
                '<span class="discountInfo" id="tdCouponDiscount"></span>' +
                '</td>' +
                '<td><span id="divSubTotal">0.00</span>Tk</td>' +
            '</tr> ' +
            '<tr id="taxRateRow" class="displayNone"> ' +
                '<td>Tax(<span id="divTaxPercent">@ViewBag.Tax</span>%)</td> ' +
                '<td><span id="taxAmount">0.00</span>Tk</td>' +
            '</tr>' +
            '<tr id="totalAmountRow" class="displayNone">' +
                '<td>Total Amount</td>' +
                '<td><span id="divTotalAmount">0.00</span>Tk</td>' +
            '</tr>' +
            '<tr id="deliveryChargeRow" class="displayNone">' +
                '<td>' +
                    'Delivery Charge(<span id="divDeliveryChargeAmount">0</span><span id="divdelChargeType"  data-delchargetype="0" data-deliveryid="0">%</span><span id="divDelChargeBeforeDisc"></span>)<br />'+
                    '<span class="discountInfo" id="tdDelivChargeDisc"></span>' +
                    '<span class="discountInfo" id="tdCouponDelivChargeDisc"></span>' +
                '</td>' +
                 '<td><span id="divDeliveryCharge">0.00</span>Tk</td>' +
            '</tr>' +
            '<tr id="orderAmountMainRow">' +
                '<td>Order Amount <span id="tdOrderAmountMainDiscountInfo" style="display:none">| <span id="orderAmountBeforeDisc">0.00</span>Tk | <span id="orderAmountDiscount">0.00</span>Tk</span></td>' +
                '<td><span id="divOrderAmountMainTotal">0.00</span>Tk</td>'+
            '</tr>'+
            '<tr id="taxAmountMainRow">'+
                '<td>Tax</td>'+
                '<td><span id="taxAmountInMain">0.00</span>Tk</td>'+
            '</tr>'+
            '<tr id="deliveryChargeMainRow">'+
                '<td>Delivery Charge</td>'+
                '<td><span id="divDeliveryChargeInMain">0.00</span>Tk</td>'+
            '</tr>'+
            '<tr id="divInvoiceRow" class="border-top">' +
                 '<td>Invoice Amount</td>' +
                 '<td><span id="divInvoiceAmount">0.00</span>Tk</td>' +
            '</tr>'
        );
    }


    //Cart list empty
    $("#emptyCartBtn").click(function () {
        $("#cartListContainer").empty();
        $("#emptyCartPlaceholder").show();
        $("#CustomerDropdown").data("kendoDropDownList").value("");

        resetCart();
        divEnable();

        liSelectedId = 0;
        totalNumber = [];
        $(".keypad").empty();
        $(".keypad").load('/PointOfSale/Numpad?isDeliveryChargeAuto=' + IsDeliveryChargeAuto);
        totalNumber = [];
        discType = 0;
        if (orderId > 0)
        {
            $("#btnSearchBySKU").click();
            $("#refundRow").remove();
            $("#orderReload").hide();
            $("#btnPaymentInfo").hide();
            $("#btnRefundInfo").hide();
            $("#productList").children().prop('disabled', false);
            $("#orderTitle").empty();
            $("#orderTitle").append('Your Order');
            $("#btnSearchByText").prop('disabled', false);
            $("#btnSearchBySKU").prop('disabled', false);
            $("#btnAvailability").prop('disabled', false);
            $("#btnCoupon").prop('disabled', false);
            orderId = 0;
        }
        if (clientId > 0)
        {
            clientId = 0;
            customerName = "";
            duePay = 0;
            debitRefill = 0;
            $("#divDebitAndCredit").hide();
            $("#CustomerDropdown").data("kendoDropDownList").value("");
            $("#orderTitle").empty();
            $("#orderTitle").append('Your Order');

            purchaseOrderId = 0;
            poItemId = 0;
            purchaseOrderQty = 0;
            $("#divPurchaseOrder").hide();
            $('#PurchaseOrderDropdown').data('kendoDropDownList').value("");


            $("#productList").empty();
            $("#productList").append('<div class="loading_partial"></div>');
            $("#productList").load('@Url.Action("ProductList","PointOfSale")');

        }
    });
    //Item Cancel
    $("#cartListContainer").on('click', ".itemCancel", function () {
        if ($(this).data("isrefundallow") == "False") {
            alert("Sorry...This product can't refund");
            return false;
        }
        if ($(this).data("id") == 0)
        {
            transactionType = parseInt($(this).data("type"));
            if (transactionType == 2) // 2 for credit payment
            {
                $("#cartItem_CreditPayment").remove();
                $("#btnCreditPayment").show();
                duePay = 0;
            }
            else if (transactionType == 3) // 3 for debit account refill
            {
                $("#cartItem_DebitRefill").remove();
                $("#btnAccountRefill").show();
                debitRefill = 0;
            }
        }
        else
        {
            id = parseInt($(this).data("id"));
            $("#cartItem_" + id).remove();
        }
        calculateCartAmount();
    });
    //***************** Place Order ********************************//
    $(".keypad").on('click', "#btnPlaceOrder", function () {
        $("#divInvoiceInfo").empty();
        orderAmount = parseFloat($("#divOrderAmountTotal").text());
        totalPrice = parseFloat($("#divSubTotal").text());
        if (orderAmount == 0) {
            alert("Cart is empty.");
        }
        else {
            orderProducts = [];
            id = 0;
            $(".singleCartItem").each(function () {
                id = parseInt($(this).data("id"));
                productId = parseInt($(this).data("productid"));
                if (id == 0) {
                    transactionType = parseInt($(this).data("type"));
                    if (transactionType == 2) // 2 for credit payment
                    {
                        orderProducts.push({
                            ProductName: "Credit Payment",
                            TransactionType: transactionType,
                            Price: duePay,
                        });
                    }
                    else if (transactionType == 3) // 3 for debit account refill
                    {
                        orderProducts.push({
                            ProductName: "Account Refill",
                            TransactionType: transactionType,
                            Price: debitRefill,
                        });
                    }
                }
                else {
                    // if borrow from another shop
                    isBorrow = false;
                    if ($("#checkBorrow_" + id).is(":checked")) {
                        isBorrow = true;
                    }
                    //service
                    isAfterSaleService = false;
                    serviceDays = 0;
                    serviceName = "";
                    if ($("#service_" + id).length == 1) {
                        isAfterSaleService = true;
                        serviceDays = parseInt($("#service_" + id).text());
                        serviceName = $("#service_" + id).data("servicename");
                    }
                    //points
                    isPointBased = false;
                    points = 0;
                    if ($("#points_" + id).length == 1) {
                        isPointBased = true;
                        points = parseInt($("#points_" + id).text());
                        totalPoints = totalPoints + points;
                    }

                    isUniqueItem = false;
                    serialNumber = "";
                    if ($("#serialNumber_" + id).length == 1) {
                        serialNumber = $("#serialNumber_" + id).text();
                        isUniqueItem = true;
                    }
                    orderProducts.push({
                        ProductId: productId,
                        ProductName: $(this).data("productname"),
                        TransactionType: 1,
                        Quantity: parseFloat($("#odrQuantity_" + id).text()).toFixed(2),
                        PerItemPrice: parseFloat($("#perItemPrice_" + id).text()).toFixed(2),
                        PerItemTotalPrice: ($("#divPerItemTotalPrice_" + id).length == 1 ? parseFloat($("#divPerItemTotalPrice_" + id).text()) : 0),
                        Price: parseFloat($("#price_" + id).text()).toFixed(2),
                        //Discount
                        Discount: ($("#discount_" + id).length == 1 ? parseFloat($("#discount_" + id).text()) : 0),
                        DiscType: ($("#discount_" + id).length == 1 ? parseInt($("#discount_" + id).data("disctype")) : 0),
                        DiscountAmount: ($("#discPerUnit_" + id).length == 1 ? parseFloat($("#discPerUnit_" + id).text()) : 0),
                        //Coupon Discount
                        CouponDiscount: ($("#couponDiscount_" + id).length == 1 ? parseFloat($("#couponDiscount_" + id).text()) : 0),
                        CouponDiscType: ($("#couponDiscount_" + id).length == 1 ? parseInt($("#couponDiscount_" + id).data("disctype")) : 0),
                        CouponDiscAmount: ($("#CouponDiscPerUnit_" + id).length == 1 ? parseFloat($("#CouponDiscPerUnit_" + id).text()) : 0),
                        SubOfferId: ($("#couponDiscount_" + id).length == 1 ? parseInt($("#couponDiscount_" + id).data("subofferid")) : 0),
                        IsBorrow: isBorrow,
                        IsAfterSaleService: isAfterSaleService,
                        ServiceDays: serviceDays,
                        ServiceName: serviceName,
                        IsPointBased: isPointBased,
                        Points: points,
                        IsUniqueItem: isUniqueItem,
                        SerialNumber: serialNumber
                    });
                }
            });

            tax = 0;
            deliveryCharge = 0;
            if ($("#taxAmount").length == 1) {
                tax = parseFloat($("#taxAmount").text());
            }

            if ($("#divDeliveryCharge").length == 1) {
                deliveryCharge = parseFloat($("#divDeliveryCharge").text());
            }

            var model =
            {
                OrderAmount: parseFloat($("#divOrderAmountMainTotal").text()).toFixed(2),
                InvoiceDiscount: ($("#orderAmountDiscount").length == 1 ? parseFloat($("#orderAmountDiscount").text()).toFixed(2) : 0),
                OrderAmountBeforeDiscount: ($("#orderAmountBeforeDisc").length == 1 ? parseFloat($("#orderAmountBeforeDisc").text()).toFixed(2) : 0),
                //Tax
                Tax: tax,
                DeliveryCharge: deliveryCharge.toFixed(2),
                InvoiceAmount: parseFloat($("#divInvoiceAmount").text()).toFixed(2),
                OrderProducts: orderProducts,
                //coupon
                OfferId: ($("#divCouponRow").length == 1 ? parseInt($("#divCouponRow").data("offerid")) : 0),
                Coupon: ($("#divCouponRow").length == 1 ? $("#divCouponRow").data("coupon") : ''),
                OfferName: ($("#divCouponRow").length == 1 ? $("#divCouponRow").data("offername") : ''),
            };

            $("#divCheckoutWin").empty();
            $("#divCheckoutWin").kendoWindow({
                actions: [],
                draggable: false,
                modal: true,
                visible: false,
                title: 'Checkout',
                resizable: false,
            });
            var checkoutWin = $("#divCheckoutWin").data("kendoWindow");
            checkoutWin.refresh({ url: '/PointOfSale/Checkout', type: "POST", data: model });
            checkoutWin.center().open().maximize();
        }
    });

    $("#kendoAutoComplete").ready(function () {
        //********************* Search product by barcode and insert into cart****************************
        function onChange()
        {
            selectedValue = this.value();
            productId = 0;
            if (selectedValue.length > 0) {
                var identityString = selectedValue.substring(0, 4);
                if (identityString.toLowerCase() == 'card')
                {
                    membershipNumber(selectedValue);
                }
                else
                {
                    $.ajax({
                        url: '@Url.Action("GetProduct", "PointOfSale")',
                        type: "Get",
                        data: { barcode: selectedValue },
                        success: function (data) {
                            if(data == "error")
                            {
                                alert("Not Found...");
                            }
                            else
                            {
                                $(data).each(function (index, item) {
                                    productId = item.ProductId;
                                    if (item.IsUnitWise == true)
                                    {
                                        if ($("#pro_" + productId).length == 1) {
                                            alert("You can't add more this product to cart");
                                            return false;
                                        }
                                        else
                                        {
                                            $("#divUnitWiseWin").empty();
                                            $("#divUnitWiseWin").kendoWindow({
                                                actions: ["Close"],
                                                draggable: false,
                                                modal: true,
                                                visible: false,
                                                width: 578,
                                                height:470,
                                                title: 'Unit Wise',
                                                resizable: false
                                            });
                                            var unitWiseWin = $("#divUnitWiseWin").data("kendoWindow");
                                            unitWiseWin.refresh('@Url.Action("Unitwise", "PointOfSale")?productId=' + productId);
                                            unitWiseWin.center().open();
                                        }
                                    }
                                    else if (item.IsUniqueItem == true)
                                    {
                                        $("#divProductSN").empty();
                                        $("#divProductSN").kendoWindow({
                                            actions: ["Close"],
                                            draggable: false,
                                            modal: true,
                                            visible: false,
                                            width: 744,
                                            height:183,
                                            title: 'Serial Number',
                                            resizable: false
                                        });
                                        var proSNWin = $("#divProductSN").data("kendoWindow");
                                        proSNWin.refresh('@Url.Action("SerialNumber", "PointOfSale")?productId=' + productId);
                                        proSNWin.center().open();
                                    }
                                    else
                                    {
                                        addProduct(productId, item.DistributeId);
                                    }
                                });
                            }
                            $("#searchStringForSKU").data("kendoAutoComplete").value("");
                        },
                        error: function () {
                            alert("Not Found...");
                            $("#searchStringForSKU").data("kendoAutoComplete").value("");
                        }
                    });
                }
            }
        }
        //Add customer by membership number
        function membershipNumber(cardNo)
        {
            $.ajax({
                url: '@Url.Action("GetCustomerByCardNoOrId", "PointOfSale")',
                type: 'Get',
                data: { cardNo: cardNo },
                success: function (data)
                {
                    if (data == "error")
                    {
                        alert("Not Found...");
                        $("#searchStringForSKU").data("kendoAutoComplete").value("");
                    }
                    else
                    {
                        $("#divDebitAndCredit").show();
                        $(data).each(function (index, item) {
                            clientId = item.CustomerId;
                            customerName = item.Name;
                            if (item.CreditAmount > 0)
                            {
                                $("#btnCreditPayment").show();
                            }
                            else
                            {
                                $("#btnCreditPayment").hide();
                            }

                            if (item.AvailableDebit < item.DebitLimit)
                            {
                                $("#btnAccountRefill").show();
                            }
                            else
                            {
                                $("#btnAccountRefill").hide();
                            }
                            $("#CustomerDropdown").data("kendoDropDownList").value(clientId);
                        });
                        $("#searchStringForSKU").data("kendoAutoComplete").value("");
                    }
                },
                error: function() {
                    alert("Not Found...");
                    $("#searchStringForSKU").data("kendoAutoComplete").value("");
                }
            });
        }
        //barcode autocomplete
        $("#searchStringForSKU").kendoAutoComplete({
                filter: "contains",
                placeholder: "Search by product barcode",
                // JSON property name to use
                dataSource: new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: '@Url.Action("GetProductList", "PointOfSale")',
                            serverPaging: true,
                            pageSize: 20,
                            contentType: 'application/json; charset=utf-8',
                            type: 'GET',
                            dataType: 'json'
                        },
                        serverSorting: true,
                        serverFiltering: true
                    }
                }),
                dataValueField: 'Value',
                dataTextField: "Text",
                change: onChange
        });

        //***************** search product by product name and add to cart ***************
        function OnSelect(e)
        {
            rowId = this.dataItem(e.item.index()).Value;
            $.ajax({
                url: '@Url.Action("GetProduct", "PointOfSale")',
                type: 'Get',
                data: { rowId: rowId },
                success: function (data)
                {
                    if (data == "error")
                    {
                        alert("Not Found...");
                    }
                    else
                    {
                        productId = data.ProductId;
                        distributeId = data.DistributeId;
                        if (data.IsUnitWise == true)
                        {
                            if ($("#pro_" + productId).length == 1)
                            {
                                alert("You can't add more this product to cart");
                                return false;
                            }
                            else
                            {
                                $("#divProductSN").empty();
                                $("#divUnitWiseWin").empty();
                                $("#divUnitWiseWin").kendoWindow({
                                    actions: ["Close"],
                                    draggable: false,
                                    modal: true,
                                    visible: false,
                                    width: 578,
                                    height:470,
                                    title: 'Unit Wise',
                                    resizable: false
                                });
                                var unitWiseWin = $("#divUnitWiseWin").data("kendoWindow");
                                unitWiseWin.refresh('@Url.Action("Unitwise", "PointOfSale")?productId=' + productId);
                                unitWiseWin.center().open();
                            }
                        }
                        else
                        if (data.IsUniqueItem == true)
                        {
                            $("#divUnitWiseWin").empty();
                            $("#divProductSN").empty();
                            $("#divProductSN").kendoWindow({
                                actions: ["Close"],
                                draggable: false,
                                modal: true,
                                visible: false,
                                width: 744,
                                height:183,
                                title: 'Serial Number',
                                resizable: false
                            });
                            var proSNWin = $("#divProductSN").data("kendoWindow");
                            proSNWin.refresh('@Url.Action("SerialNumber", "PointOfSale")?productId=' + productId);
                            proSNWin.center().open();
                        }
                        else
                        {
                            addProduct(productId, distributeId);
                        }
                    }
                },
                error: function() {
                    alert("Not Found...");
                    $("#searchStringForText").data("kendoAutoComplete").value("");
                }
            });
           //addProduct(productId);
        }
        function onChangeText()
        {
            $("#searchStringForText").data("kendoAutoComplete").value("");
        }
        $("#searchStringForText").kendoAutoComplete({
                filter: "contains",
                placeholder: "Search by product name...",
                // JSON property name to use
                dataSource: new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: '@Url.Action("GetProductListForText", "PointOfSale")',
                            serverPaging: true,
                            pageSize: 20,
                            contentType: 'application/json; charset=utf-8',
                            type: 'GET',
                            dataType: 'json'
                        },
                        serverSorting: true,
                        serverFiltering: true
                    }
                }),
                dataValueField: 'Value',
                dataTextField: "Text",
                select: OnSelect,
                change: onChangeText
        });

        //************************** search order and add to cart for refund/change *********************
        function onChangeOrder(e)
        {
            $("#searchStringOrder").data("kendoAutoComplete").value("");
        }
        function onSelectOrder(e)
        {
            var selectedOne = this.dataItem(e.item.index());
            orderId = selectedOne.Value;
            if (orderId > 0)
            {
                $("#emptyCartPlaceholder").hide();
                $("#cartListContainer").empty();
                $("#cartListContainer").load('@Url.Action("OrderedInfo", "PointOfSale")?orderId=' + orderId);
                $("#orderReload").show();
                $("#btnPaymentInfo").show();
                $("#btnRefundInfo").show();
                //$("#productList").children().prop('disabled', true);
                $(".keypad").empty();
                $(".keypad").load('@Url.Action("RefundQuantityNumpad", "PointOfSale")');
                $("#btnSearchByText").prop('disabled', true);
                $("#btnSearchBySKU").prop('disabled', true);
                $("#btnAvailability").prop('disabled', true);
                $("#btnCoupon").prop('disabled', true);

                $("#divDebitAndCredit").css("display", "none");
            }
            else
            {
                orderId = 0;
            }
        }
        $("#orderReload").click(function () {
            if (orderId > 0)
            {
                $("#btnRefundPay").addClass('disabled');
                $("#btnPrint").addClass('disabled');
                $("#emptyCartPlaceholder").hide();
                $("#cartListContainer").empty();
                $("#cartListContainer").load('@Url.Action("OrderedInfo", "PointOfSale")?orderId=' + orderId);
                $("#refundRow").remove();
            }
        });
        //order payment info
        $("#divCheckoutWin").on('click', "#btnPaymentInfo", function () {
            document.getElementById("btnPaymentInfo").click();
        });

        $("#btnPaymentInfo").click(function () {
            $("#divPaymentTranWin").empty();
            $("#divPaymentTranWin").kendoWindow({
                    actions: ["Close"],
                    draggable: false,
                    modal: true,
                    visible: false,
                    width: 1243,
                    height: 405,
                    resizable: false,
                    title: 'Payment Transaction'
            });
            var paymentTranWin = $("#divPaymentTranWin").data("kendoWindow");
            paymentTranWin.refresh('@Url.Action("PaymentHistoryPartial", "PointOfSale")?orderId=' + orderId);
            paymentTranWin.center().open();
        });

        $("#btnRefundInfo").click(function () {
            $("#divRefundInfoWin").empty();
            $("#divRefundInfoWin").kendoWindow({
                    actions: ["Close"],
                    draggable: false,
                    modal: true,
                    visible: false,
                    width: 1037,
                    height: 405,
                    resizable: false,
                    title: 'Refund Info'
                });
            var refundInfoWin = $("#divRefundInfoWin").data("kendoWindow");
            refundInfoWin.refresh('@Url.Action("RefundInfo", "PointOfSale")?orderId=' + orderId);
            refundInfoWin.center().open();
        });

        $("#searchStringOrder").kendoAutoComplete({
                filter: "contains",
                placeholder: "Search order by order number",
                // JSON property name to use
                dataSource: new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: '@Url.Action("GetOrderList", "PointOfSale")',
                            serverPaging: true,
                            pageSize: 20,
                            contentType: 'application/json; charset=utf-8',
                            type: 'GET',
                            dataType: 'json'
                        },
                        serverSorting: true,
                        serverFiltering: true
                    }
                }),
                dataValueField: 'Value',
                dataTextField: "Text",
                select: onSelectOrder,
                change: onChangeOrder
        });
        //******************************Search Availability of product quantity*********************
        function onChangeAvailability()
        {
            selectedValue = this.value();
            if (selectedValue.length > 0)
            {
                $.ajax({
                    url: '@Url.Action("GetProduct", "PointOfSale")',
                    type: "GET",
                    data: { barcode: selectedValue },
                    success: function (data)
                    {
                        $("#divAvailabilityWin").empty();
                        $("#divAvailabilityWin").kendoWindow({
                            actions: ["Close"],
                            draggable: false,
                            modal: true,
                            visible: false,
                            width: 476,
                            height:171,
                            title: 'Product Availability',
                            resizable: false
                        });
                        var availabilityWin = $("#divAvailabilityWin").data("kendoWindow");
                        availabilityWin.refresh('@Url.Action("AvailabilityOfProduct", "PointOfSale")?productId=' + data.ProductId + '&distributeId=' + data.DistributeId);
                        availabilityWin.center().open();
                        $("#searchStringAvailability").data("kendoAutoComplete").value("");
                    },
                    error: function ()
                    {
                        alert("Not Found...");
                        $("#searchStringAvailability").data("kendoAutoComplete").value("");
                    }
                });
            }
        }
        $("#searchStringAvailability").kendoAutoComplete({
                filter: "contains",
                placeholder: "Search by product barcode",
                // JSON property name to use
                dataSource: new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: '@Url.Action("GetProductList", "PointOfSale")',
                            serverPaging: true,
                            pageSize: 20,
                            contentType: 'application/json; charset=utf-8',
                            type: 'GET',
                            dataType: 'json'
                        },
                        serverSorting: true,
                        serverFiltering: true
                    }
                }),
                dataValueField: 'Value',
                dataTextField: "Text",
                change: onChangeAvailability
        });
       //******************************Search Availability of product quantity*********************
        function onChangeCoupon()
        {
            $("#divInvoiceInfo").empty();
            $("#divCheckoutWin").empty();
            if ($("#divCouponRow").length == 1)
            {
                alert("Coupon is already used.");
                $("#searchStringCoupon").data("kendoAutoComplete").value("");
                return false;
            }
            selectedValue = this.value();
            if (selectedValue.length > 0)
            {
                totalPrice = 0;
                totalPrice = parseFloat($("#divSubTotal").text());
                //if customer due pay by credit payment
                if (duePay > 0) {
                    totalPrice = totalPrice - duePay;
                }
                //if debit account refill
                if (debitRefill > 0) {
                    totalPrice = totalPrice - debitRefill;
                }

                if (totalPrice == 0)
                {
                    alert("Cart is empty.");
                    $("#searchStringCoupon").data("kendoAutoComplete").value("");
                    return false;
                }

                deliveryCharge = 0;
                if ($("#divDeliveryCharge").length == 1)
                {
                    if ($("#deliveryChargeBeforeDisc").length == 1) {
                        deliveryCharge = parseFloat($("#deliveryChargeBeforeDisc").text());
                    }
                    else
                    {
                        deliveryCharge = parseFloat($("#divDeliveryCharge").text());
                    }
                }

                var orderProducts = [];
                $(".singleCartItem").each(function () {
                    id = parseInt($(this).data("id"));
                    if (id > 0) {
                        orderProducts.push({
                            Id: id,
                            ProductId: parseInt($(this).data("productid")),
                            DistributeId: $(this).data("distributeid"),
                            Quantity: parseInt($("#odrQuantity_" + id).text()),
                        });
                    }
                });

                $.ajax({
                    url: '/PointOfSale/GetCouponInfo',
                    type: "POST",
                    data: JSON.stringify({ couponCode: selectedValue, invoiceAmount: totalPrice, deliveryCharge: deliveryCharge, orderProducts: orderProducts }),
                    contentType: 'application/json',
                    success: function (data)
                    {
                        if (data == "expired")
                        {
                            alert("This Coupon is Expired.");
                        }
                        else
                        if (data == "notyet")
                        {
                            alert("This Coupon not available.");
                        }
                        else
                        if (data == "notValid")
                        {
                            alert("This Coupon not valid in this cart.");
                        }
                        else
                        {
                            $("#divAll *").prop('disabled',true);
                            $("#btnPlaceOrder").prop('disabled', false);
                            $("#btnInvoiceInfo").prop('disabled', false);
                            $("#emptyCartBtn").prop('disabled', false);
                            //$("#OrderContainer *").prop('disabled',false);
                            $("#divLeft").addClass('blur');

                            var customerDropdown = $("#CustomerDropdown").data("kendoDropDownList");
                            customerDropdown.enable(false);

                            var purchaseOrderDropdown = $("#PurchaseOrderDropdown").data("kendoDropDownList");
                            purchaseOrderDropdown.enable(false);

                            //customerDropdown.enable(true);


                            if (data.Type == 2) // product coupon
                            {
                                if (data.subOfferId == 1) //B1G1
                                {
                                    quantity = 0;
                                    price = 0;
                                    discountAmount = 0;

                                    quantity = parseInt($("#odrQuantity_" + data.Id).text());
                                    price = parseFloat($("#perItemPrice_" + data.Id).text()) * quantity;

                                    if (quantity > 1)
                                    {
                                        if ($('#divPerItemTotalPrice_' + data.Id).length > 0)
                                        {
                                            $("#divPerItemTotalPrice_" + data.Id).empty();
                                            $("#divPerItemTotalPrice_" + data.Id).append(price.toFixed(2));
                                        }
                                        else
                                        {
                                            $("#divPerItemTotal_" + data.Id).append(' <span id="divPerItemTotalPrice_' + data.Id + '">' + price.toFixed(2) + '</span> Tk</span> | ');
                                        }
                                    }
                                    discountAmount = parseFloat($("#perItemPrice_" + data.Id).text()) * data.quantity;
                                    $("#discPerItem_" + data.Id).hide();
                                    $("#discCouponPerItem_" + data.Id).empty();
                                    $("#discCouponPerItem_" + data.Id).show();
                                    $("#discCouponPerItem_" + data.Id).append('Coupon(B1G1 <i class="fa fa-times"></i> <span id="couponDiscount_' + data.Id + '" data-disctype="0" data-offertype="3" data-offerid="' + data.offerItemId +'" data-subOfferId="'+ data.subOfferId +'">' + data.quantity + '</span>) -<span id="CouponDiscPerUnit_' + data.Id + '">' + discountAmount.toFixed(2) + '</span>Tk<span class="couponPerItemCancel" data-id="' + data.Id + '"></span>');

                                    if ($("#discPerUnit_" + data.Id).length == 1)
                                    {
                                        if (parseFloat($("#discPerUnit_" + data.Id).text()) > discountAmount)
                                        {
                                            $("#discPerItem_" + data.Id).show();
                                            $("#discCouponPerItem_" + data.Id).hide();
                                        }
                                        else
                                        {
                                            price = price - discountAmount;
                                            $("#price_" + data.Id).empty();
                                            $("#price_" + data.Id).append(price.toFixed(2));
                                            calculateCartAmount();
                                        }
                                    }
                                    else
                                    {
                                        price = price - discountAmount;
                                        $("#price_" + data.Id).empty();
                                        $("#price_" + data.Id).append(price.toFixed(2));
                                        calculateCartAmount();
                                    }
                                    $(".summaryTbl").append(' <tr class="border-top" id="divCouponRow" data-offerid="' + data.OfferId + '"  data-offername="' + data.OfferName + '" data-coupon="' + selectedValue + '" data-type="' + data.Type + '">' +
                                        '<td>' + data.OfferName +'(' + selectedValue + ')</td>' +
                                        '<td>' +
                                        '<span><span class="fa fa-times-circle" style="cursor:pointer" id="btnProductCouponCodeCancel"></span></span>' +
                                        '</td>' +
                                        '</tr>');
                                }
                                else if (data.subOfferId == 2) //B2G1
                                {
                                    quantity = 0;
                                    price = 0;
                                    discountAmount = 0;

                                    quantity = parseInt($("#odrQuantity_" + data.Id).text());
                                    price = parseFloat($("#perItemPrice_" + data.Id).text()) * quantity;

                                    if (quantity > 1)
                                    {
                                        if ($('#divPerItemTotalPrice_' + data.Id).length > 0)
                                        {
                                            $("#divPerItemTotalPrice_" + data.Id).empty();
                                            $("#divPerItemTotalPrice_" + data.Id).append(price.toFixed(2));
                                        }
                                        else
                                        {
                                            $("#divPerItemTotal_" + data.Id).append(' <span id="divPerItemTotalPrice_' + data.Id + '">' + price.toFixed(2) + '</span> Tk</span> | ');
                                        }
                                    }
                                    discountAmount = parseFloat($("#perItemPrice_" + data.Id).text()) * data.quantity;
                                    $("#discPerItem_" + data.Id).hide();
                                    $("#discCouponPerItem_" + data.Id).empty();
                                    $("#discCouponPerItem_" + data.Id).show();
                                    $("#discCouponPerItem_" + data.Id).append('Coupon(B2G1 <i class="fa fa-times"></i> <span id="couponDiscount_' + data.Id + '" data-disctype="0" data-offertype="3" data-offerid="' + data.offerItemId +'" data-subOfferId="'+ data.subOfferId +'">' + data.quantity + '</span>) -<span id="CouponDiscPerUnit_' + data.Id + '">' + discountAmount.toFixed(2) + '</span>Tk<span class="couponPerItemCancel" data-id="' + data.Id + '"></span>');

                                    if ($("#discPerUnit_" + data.Id).length == 1)
                                    {
                                        if (parseFloat($("#discPerUnit_" + data.Id).text()) > discountAmount)
                                        {
                                            $("#discPerItem_" + data.Id).show();
                                            $("#discCouponPerItem_" + data.Id).hide();
                                        }
                                        else
                                        {
                                            price = price - discountAmount;
                                            $("#price_" + data.Id).empty();
                                            $("#price_" + data.Id).append(price.toFixed(2));
                                            calculateCartAmount();
                                        }
                                    }
                                    else
                                    {
                                        price = price - discountAmount;
                                        $("#price_" + data.Id).empty();
                                        $("#price_" + data.Id).append(price.toFixed(2));
                                        calculateCartAmount();
                                    }
                                    $(".summaryTbl").append(' <tr class="border-top" id="divCouponRow" data-offerid="' + data.OfferId + '"  data-offername="' + data.OfferName + '" data-coupon="' + selectedValue + '" data-type="' + data.Type + '">' +
                                        '<td>' + data.OfferName +'(' + selectedValue + ')</td>' +
                                        '<td>' +
                                        '<span><span class="fa fa-times-circle" style="cursor:pointer" id="btnProductCouponCodeCancel"></span></span>' +
                                        '</td>' +
                                        '</tr>');
                                }
                                else
                                {
                                    $(data.existingItem).each(function (index, item) {
                                        quantity = 0;
                                        price = 0;
                                        discountAmount = 0;

                                        quantity = parseInt($("#odrQuantity_" + item.Id).text());
                                        price = parseFloat($("#perItemPrice_" + item.Id).text()) * quantity;
                                        if (quantity > 1)
                                        {
                                            if ($('#divPerItemTotalPrice_' + item.Id).length > 0)
                                            {
                                                $("#divPerItemTotalPrice_" + item.Id).empty();
                                                $("#divPerItemTotalPrice_" + item.Id).append(price.toFixed(2));
                                            }
                                            else
                                            {
                                                $("#divPerItemTotal_" + item.Id).append(' <span id="divPerItemTotalPrice_' + item.Id + '">' + price.toFixed(2) + '</span> Tk</span> | ');
                                            }
                                        }
                                        discountAmount = price * (item.PercentageOff / 100);

                                        $("#discPerItem_" + item.Id).hide();
                                        $("#discCouponPerItem_" + item.Id).empty();
                                        $("#discCouponPerItem_" + item.Id).show();
                                        $("#discCouponPerItem_" + item.Id).append('Coupon(<span id="couponDiscount_' + item.Id + '" data-disctype="0" data-offertype="3" data-offerid="' + item.OfferId +'" data-subOfferId="'+ data.subOfferId +'">' + item.PercentageOff + '</span>%) | -<span id="CouponDiscPerUnit_' + item.Id + '">' + discountAmount.toFixed(2) + '</span>Tk <span class="couponPerItemCancel" data-id ="' + item.Id + '"></span>');

                                        if ($("#discPerUnit_" + item.Id).length == 1)
                                        {
                                            if (parseFloat($("#discPerUnit_" + item.Id).text()) > discountAmount)
                                            {
                                                $("#discPerItem_" + item.Id).show();
                                                $("#discCouponPerItem_" + item.Id).hide();
                                            }
                                            else
                                            {
                                                price = price - discountAmount;
                                                $("#price_" + item.Id).empty();
                                                $("#price_" + item.Id).append(price.toFixed(2));
                                            }
                                        }
                                        else
                                        {
                                            price = price - discountAmount;
                                            $("#price_" + item.Id).empty();
                                            $("#price_" + item.Id).append(price.toFixed(2));
                                        }
                                      });
                                    calculateCartAmount();
                                    $(".summaryTbl").append(' <tr class="border-top" id="divCouponRow" data-offerid="' + data.OfferId + '"  data-offername="' + data.OfferName + '" data-coupon="' + selectedValue + '" data-type="' + data.Type + '">' +
                                        '<td>' + data.OfferName +' (' + selectedValue + ')</td>' +
                                        '<td>' +
                                        '<span><span class="fa fa-times-circle" style="cursor:pointer" id="btnProductCouponCodeCancel"></span></span>' +
                                        '</td>' +
                                        '</tr>');
                                }
                            }
                            else
                            if (data.Type == 3) // delivery charge coupon
                            {
                                totalPrice = parseFloat($("#divTotalAmount").text());

                                //check if already delivery charge discount
                                if ($("#divDelChargeDiscount").length > 0) {
                                    deliveryChargeDiscount = parseFloat($("#divDelChargeDiscount").text());
                                    if (data.discountDeliveryCharge > deliveryChargeDiscount)
                                    {
                                        $("#tdDelivChargeDisc").hide();
                                        $("#tdCouponDelivChargeDisc").empty();
                                        $("#tdCouponDelivChargeDisc").show();
                                        $("#tdCouponDelivChargeDisc").append(
                                            'Coupon(<span id="divCouponDelChargeDiscPercent" data-offertype="3" data-offerid="' + data.delDiscId +'">' + data.Percentage + '</span>%) | ' +
                                            '-<span id="divCouponDelChargeDiscount">' + data.discountDeliveryCharge.toFixed(2) + '</span>Tk'
                                        );

                                        deliveryCharge = deliveryCharge - data.discountDeliveryCharge;
                                        totalPrice = totalPrice + deliveryCharge;

                                        $("#divDeliveryCharge").empty();
                                        $("#divDeliveryCharge").append(deliveryCharge.toFixed(2));

                                        $("#divInvoiceAmount").empty();
                                        $("#divInvoiceAmount").append(totalPrice.toFixed(2));
                                    }
                                    else
                                    {
                                        $("#tdCouponDelivChargeDisc").empty();
                                        $("#tdCouponDelivChargeDisc").hide();
                                        $("#tdCouponDelivChargeDisc").append(
                                            'Coupon(<span id="divCouponDelChargeDiscPercent" data-offertype="3" data-offerid="' + data.delDiscId +'">' + data.Percentage + '</span>%) | ' +
                                            '-<span id="divCouponDelChargeDiscount">' + data.discountDeliveryCharge.toFixed(2) + '</span>Tk'
                                        );
                                    }
                                }
                                else
                                {
                                    $("#divDelChargeBeforeDisc").empty();
                                    $("#divDelChargeBeforeDisc").append(
                                        ' | <span id="deliveryChargeBeforeDisc">' + deliveryCharge + '</span>Tk'
                                    );

                                    $("#tdDelivChargeDisc").hide();
                                    $("#tdCouponDelivChargeDisc").empty();
                                    $("#tdCouponDelivChargeDisc").show();
                                    $("#tdCouponDelivChargeDisc").append(
                                        'Coupon(<span id="divCouponDelChargeDiscPercent" data-offertype="3" data-offerid="' + data.delDiscId +'">' + data.Percentage + '</span>%) | ' +
                                        '-<span id="divCouponDelChargeDiscount">' + data.discountDeliveryCharge.toFixed(2) + '</span>Tk'
                                    );

                                    deliveryCharge = deliveryCharge - data.discountDeliveryCharge;
                                    totalPrice = totalPrice + deliveryCharge;

                                    $("#divDeliveryCharge").empty();
                                    $("#divDeliveryCharge").append(deliveryCharge.toFixed(2));


                                    $("#divInvoiceAmount").empty();
                                    $("#divInvoiceAmount").append(totalPrice.toFixed(2));
                                }

                                calculateOrderMainView();

                                $(".summaryTbl").append(' <tr class="border-top" id="divCouponRow" data-offerid="' + data.OfferId + '"  data-offername="' + data.OfferName + '" data-coupon="' + selectedValue + '" data-type="' + data.Type + '">' +
                                    '<td>' + data.OfferName + '(' + selectedValue + ')</td>' +
                                    '<td>' +
                                    '<span><span class="fa fa-times-circle" style="cursor:pointer" id="btnDelChargeCouponCodeCancel"></span></span>' +
                                    '</td>' +
                                    '</tr>');
                             }
                            else if (data.Type == 4) // amount coupon
                            {
                                disCount = data.invoiceDiscount; //coupon discount;
                                if ($("#divDiscValue").length > 0)
                                {
                                    invoiceDiscount = parseFloat($("#divDiscValue").text()); // invoiceDiscount
                                    discountAmount = parseFloat($("#divDiscItemTotal").text()); // item discount
                                    if (disCount > invoiceDiscount)
                                    {
                                        if (discountAmount > 0)
                                        {
                                            if (disCount > discountAmount)
                                            {
                                                disCount = disCount - discountAmount;
                                                totalPrice = totalPrice - disCount;
                                            }
                                            else
                                            {
                                                disCount = 0;
                                            }
                                        }
                                        else
                                        {
                                            totalPrice = totalPrice - disCount;
                                        }
                                        $("#tdDiscount").hide();
                                        $("#tdCouponDiscount").show();
                                        $("#tdCouponDiscount").empty();

                                        $("#divSubTotalBeforeDisc").empty();
                                        $("#divSubTotalBeforeDisc").append(
                                            '(<span id="subTotalBeforeDisc">' + totalPrice.toFixed(2) + '</span>Tk)'
                                        );

                                        if (data.IsPercentile) {

                                            $("#tdCouponDiscount").append(
                                                'Coupon Amount(<span id="divCouponDiscAmount" data-disctype="0" data-offertype="3" data-offerid="'+ data.Id +'">' + data.Amount + '</span>%) | <span id="divCouponDiscValue">' + data.invoiceDiscount.toFixed(2) + '</span>Tk  | -<span id="divCouponInvoiceDiscount">' + disCount.toFixed(2) + '</span>Tk'
                                            );
                                        }
                                        else {
                                            $("#tdCouponDiscount").append(
                                                'Coupon Amount(<span id="divCouponDiscAmount" data-disctype="1" data-offertype="3" data-offerid="' + data.Id +'">' + data.Amount + '</span>Tk) | <span id="divCouponDiscValue">' + data.invoiceDiscount.toFixed(2) + '</span>Tk  | -<span id="divCouponInvoiceDiscount">' + disCount.toFixed(2) + '</span>Tk'
                                            );
                                        }
                                        calculateCartAmount(disCount);
                                    }
                                    else
                                    {
                                        $("#tdCouponDiscount").empty();
                                        $("#tdCouponDiscount").hide();
                                        if (data.IsPercentile) {
                                            $("#tdCouponDiscount").append(
                                                'Coupon Amount(<span id="divCouponDiscAmount" data-disctype="0">' + data.Amount + '</span>%) | <span id="divCouponDiscValue">' + data.invoiceDiscount.toFixed(2) + '</span>Tk  | -<span id="divCouponInvoiceDiscount">' + disCount.toFixed(2) + '</span>Tk'
                                            );
                                        }
                                        else
                                        {
                                            $("#tdCouponDiscount").append(
                                                'Coupon Amount(<span id="divCouponDiscAmount" data-disctype="1">' + data.Amount + '</span>Tk) | <span id="divCouponDiscValue">' + data.invoiceDiscount.toFixed(2) + '</span>Tk  | -<span id="divCouponInvoiceDiscount">' + disCount.toFixed(2) + '</span>Tk'
                                            );
                                        }
                                    }
                                }
                                else
                                {
                                    discountAmount = parseFloat($("#divDiscItemTotal").text()); // item discount
                                    if (disCount > discountAmount) {
                                        disCount = disCount - discountAmount;
                                        totalPrice = totalPrice - disCount;
                                    }
                                    else
                                    {
                                        disCount = 0;
                                    }


                                    $("#divSubTotalBeforeDisc").empty();
                                    $("#divSubTotalBeforeDisc").append(
                                        '(<span id="subTotalBeforeDisc">' + totalPrice.toFixed(2) + '</span>Tk)'
                                    );

                                    $("#tdCouponDiscount").empty();
                                    $("#tdCouponDiscount").show();
                                    if (data.IsPercentile) {

                                        $("#tdCouponDiscount").append(
                                            'Coupon Amount(<span id="divCouponDiscAmount" data-disctype="0">' + data.Amount + '</span>%) | <span id="divCouponDiscValue">' + data.invoiceDiscount.toFixed(2) + '</span>Tk  | -<span id="divCouponInvoiceDiscount">' + disCount.toFixed(2) + '</span>Tk'
                                        );
                                    }
                                    else {
                                        $("#tdCouponDiscount").append(
                                            'Coupon Amount(<span id="divCouponDiscAmount" data-disctype="1">' + data.Amount + '</span>Tk) | <span id="divCouponDiscValue">' + data.invoiceDiscount.toFixed(2) + '</span>Tk  | -<span id="divCouponInvoiceDiscount">' + disCount.toFixed(2) + '</span>Tk'
                                        );
                                    }
                                    calculateCartAmount(data.invoiceDiscount);
                                }
                                $(".summaryTbl").append(' <tr class="border-top" id="divCouponRow" data-offerid="' + data.OfferId + '"  data-offername="' + data.OfferName + '" data-coupon="' + selectedValue + '" data-type="' + data.Type + '">' +
                                    '<td>' + data.OfferName +'(' + selectedValue +')</td>' +
                                    '<td>' +
                                    '<span><span class="fa fa-times-circle" style="cursor:pointer" id="btnAmountCouponCodeCancel"></span></span>' +
                                    '</td>' +
                                    '</tr>');
                             }
                        }
                        $("#searchStringCoupon").data("kendoAutoComplete").value("");
                    },
                    error: function ()
                    {
                        alert("Not Found...");
                        $("#searchStringCoupon").data("kendoAutoComplete").value("");
                    }
                });
            }
        }
        $("#searchStringCoupon").kendoAutoComplete({
                filter: "contains",
                placeholder: "Search by Coupon",
                // JSON property name to use
                dataSource: new kendo.data.DataSource({
                    transport: {
                        read: {
                            url: '/PointOfSale/GetCouponList',
                            serverPaging: true,
                            pageSize: 20,
                            contentType: 'application/json; charset=utf-8',
                            type: 'GET',
                            dataType: 'json'
                        },
                        serverSorting: true,
                        serverFiltering: true
                    }
                }),
                dataValueField: 'Value',
                dataTextField: "Text",
                change: onChangeCoupon
        });

        //************change search box search type : barcode,name,order,Availability *********************
        $("#btnSearchByText").click(function () {
            $(this).addClass("selected");
            $("#btnSearchBySKU").removeClass("selected");
            $("#btnOrders").removeClass("selected");
            $("#btnAvailability").removeClass("selected");
            $("#btnOffer").removeClass("selected");
            $("#btnCoupon").removeClass("selected");

            $("#divSearchStringSKU").hide();
            $("#divSearchStringOrder").hide();
            $("#divSearchStringAvailability").hide();
            $("#divSearchCoupon").hide();
            $("#divSearchStringText").show();
        });
        $("#btnSearchBySKU").click(function () {
            $(this).addClass("selected");
            $("#btnSearchByText").removeClass("selected");
            $("#btnOrders").removeClass("selected");
            $("#btnAvailability").removeClass("selected");
            $("#btnOffer").removeClass("selected");
            $("#btnCoupon").removeClass("selected");


            $("#divSearchStringText").hide();
            $("#divSearchStringOrder").hide();
            $("#divSearchStringAvailability").hide();
            $("#divSearchCoupon").hide();

            $("#divSearchStringSKU").show();
        });

        $("#btnOrders").click(function () {
            $(this).addClass("selected");
            $("#btnSearchByText").removeClass("selected");
            $("#btnSearchBySKU").removeClass("selected");
            $("#btnAvailability").removeClass("selected");
            $("#btnOffer").removeClass("selected");
            $("#btnCoupon").removeClass("selected");


            $("#divSearchStringText").hide();
            $("#divSearchStringSKU").hide();
            $("#divSearchStringAvailability").hide();
            $("#divSearchCoupon").hide();

            $("#divSearchStringOrder").show();
        });

        $("#btnAvailability").click(function () {
            $(this).addClass("selected");
            $("#btnSearchByText").removeClass("selected");
            $("#btnSearchBySKU").removeClass("selected");
            $("#btnOrders").removeClass("selected");
            $("#btnOffer").removeClass("selected");
            $("#btnCoupon").removeClass("selected");


            $("#divSearchStringText").hide();
            $("#divSearchStringSKU").hide();
            $("#divSearchStringOrder").hide();
            $("#divSearchCoupon").hide();
            $("#divSearchStringAvailability").show();
        });


        $("#btnCoupon").click(function () {
            $(this).addClass("selected");
            $("#btnSearchByText").removeClass("selected");
            $("#btnSearchBySKU").removeClass("selected");
            $("#btnOrders").removeClass("selected");
            $("#btnOffer").removeClass("selected");
            $("#btnAvailability").removeClass("selected");

            $("#divSearchStringText").hide();
            $("#divSearchStringSKU").hide();
            $("#divSearchStringOrder").hide();
            $("#divSearchStringAvailability").hide();
            $("#divSearchCoupon").show();
        });
    });
    //*********************** Discount Function *******************************
    //change numpad to discount numpad
    $(".keypad").on('click', '#btnDiscount', function () {
        totalPrice = 0.00;
        $(".subitemPrice").each(function () {
            totalPrice = totalPrice + parseFloat($(this).text());
        });
        if (totalPrice == 0) {
            alert("Cart is Empty...");
        }
        else {
            $(".keypad").empty();
            $(".keypad").load('@Url.Action("DiscounNumpad", "PointOfSale")');
        }
    });

    //change discount
    $(".keypad").on('click', '.disLetter', function () {
        number = $(this).text();
        totalNumber.push(number);
        disCount = parseInt(totalNumber.join(""));
        totalPrice = 0;
        if (liSelectedId > 0) //discount per item
        {
            if ($("#discount_" + liSelectedId).length == 1 || $("#couponDiscount_" + liSelectedId).length == 1)
            {
                if (parseInt($("#discount_" + liSelectedId).data("offertype")) == 1)
                {
                    //continue
                }
                else
                {
                    alert("Discount is already used in this item.");
                    return false;
                }
            }

            if ($("#perItemPrice_" + liSelectedId).data("isdiscountallow") == true)
            {
                quantity = parseInt($("#odrQuantity_" + liSelectedId).text());
                price = parseFloat($("#perItemPrice_" + liSelectedId).text()) * quantity;
                if (quantity > 1) {
                    if ($('#divPerItemTotalPrice_' + liSelectedId).length > 0) {
                        $("#divPerItemTotalPrice_" + liSelectedId).empty();
                        $("#divPerItemTotalPrice_" + liSelectedId).append(price.toFixed(2));
                    }
                    else {
                        $("#divPerItemTotal_" + liSelectedId).append(' <span id="divPerItemTotalPrice_' + liSelectedId + '">' + price.toFixed(2) + '</span> Tk</span> | ');
                    }
                }
                if ($("#discFixed").is(":checked")) {
                    discountAmount = quantity * disCount;
                    price = price - discountAmount;
                    if (price >= 0)
                    {
                        $("#discPerItem_" + liSelectedId).empty();
                        $("#discPerItem_" + liSelectedId).append('Discount(<span id="discount_' + liSelectedId + '" data-disctype="1" data-offertype="1" data-offerid="0">' + disCount + '</span>Tk) | -<span id="discPerUnit_' + liSelectedId + '">' + discountAmount.toFixed(2) + '</span>Tk');
                        $("#price_" + liSelectedId).empty();
                        $("#price_" + liSelectedId).append(price.toFixed(2));
                        calculateCartAmount();
                    }
                }
                else
                if ($("#discPercent").is(":checked"))
                {
                    if (disCount <= 100)
                    {
                        discountAmount = price * (disCount / 100);
                        price = price - discountAmount;
                        $("#discPerItem_" + liSelectedId).empty();
                        $("#discPerItem_" + liSelectedId).append('Discount(<span id="discount_' + liSelectedId + '" data-disctype="0" data-offertype="1" data-offerid="0">' + disCount + '</span>%) | -<span id="discPerUnit_' + liSelectedId + '">' + discountAmount.toFixed(2) + '</span>Tk');
                        $("#price_" + liSelectedId).empty();
                        $("#price_" + liSelectedId).append(price.toFixed(2));
                        calculateCartAmount();
                    }
                }
            }
            else
            {
                alert("Discount not allow for this product");
            }
        }
        else // discount on invoice total
        {
            if($("#divDiscountAmount").length == 1 || $("#divCouponDiscAmount").length == 1) {
                if (parseInt($("#divDiscountAmount").data("offertype")) == 1) {
                    //continue
                }
                else
                {
                    alert("Discount is already used.");
                    return false;
                }
            }

            totalPrice = parseFloat($("#divSubTotal").text());

            //if customer due pay by credit payment
            if (duePay > 0)
            {
                totalPrice = totalPrice - duePay;
            }
            //if debit account refill
            if (debitRefill > 0) {
                totalPrice = totalPrice - debitRefill;
            }

            invoiceDiscount = parseFloat($("#divDiscItemTotal").text());

            if ($("#discFixed").is(":checked"))
            {
                discountAmount = disCount;
                if (invoiceDiscount > 0)
                {
                    if (discountAmount > invoiceDiscount)
                    {
                        discountAmount = discountAmount - invoiceDiscount;
                    }
                    else
                    {
                        discountAmount = 0;
                    }
                }
                totalPrice = totalPrice - discountAmount;
                if (totalPrice >= 0)
                {
                    $("#divSubTotal").empty();
                    $("#divSubTotal").append(totalPrice.toFixed(2));
                    totalPrice = totalPrice + discountAmount;
                    $("#divSubTotalBeforeDisc").empty();
                    $("#divSubTotalBeforeDisc").append(
                        '(<span id="subTotalBeforeDisc">' + totalPrice.toFixed(2) + '</span>Tk)'
                    );

                    $("#tdDiscount").empty();
                    $("#tdDiscount").show();
                    $("#tdDiscount").append('Discount Amount(<span id="divDiscountAmount" data-disctype="1" data-offertype="1" data-offerid="0">' + disCount + '</span>Tk) | <span id="divDiscValue">' + disCount.toFixed(2) + '</span>Tk  | -<span id="divInvoiceDiscount">' + discountAmount.toFixed(2) + '</span>Tk')
                    calculateCartAmount();
                }
            }
            else
            if ($("#discPercent").is(":checked"))
            {
                discPercent = disCount;
                disCount = totalPrice * (discPercent / 100);
                discountAmount = disCount;
                if (invoiceDiscount > 0) {
                    if (discountAmount > invoiceDiscount) {
                        discountAmount = discountAmount - invoiceDiscount;
                    }
                    else {
                        discountAmount = 0;
                    }
                }
                totalPrice = totalPrice - discountAmount;
                if (discPercent <= 100)
                {
                    $("#divSubTotal").empty();
                    $("#divSubTotal").append(totalPrice.toFixed(2));
                    totalPrice = totalPrice + discountAmount;
                    $("#divSubTotalBeforeDisc").empty();
                    $("#divSubTotalBeforeDisc").append(
                        '(<span id="subTotalBeforeDisc">' + totalPrice.toFixed(2) + '</span>Tk)'
                    );

                    $("#tdDiscount").empty();
                    $("#tdDiscount").show();
                    $("#tdDiscount").append('Discount Amount(<span id="divDiscountAmount" data-disctype="0" data-offertype="1" data-offerid="0">' + discPercent + '</span>%) | <span id="divDiscValue">' + disCount.toFixed(2) + '</span>Tk  | -<span id="divInvoiceDiscount">' + discountAmount.toFixed(2) + '</span>Tk')
                    calculateCartAmount();
                }
            }
        }
    });
    //per item discount cancel
    $("#cartListContainer").on('click', ".discPerItemCancel", function () {
        id = $(this).data("id");
        $("#discPerItem_" + id).show();
        $("#discPerItem_" + id).empty();
        $("#divPerItemTotal_" + id).empty();
        quantity = parseInt($("#odrQuantity_" + id).text());
        price = parseFloat($("#perItemPrice_" + id).text()).toFixed(2) * quantity;
        $("#price_" + id).empty();
        $("#price_" + id).append(price.toFixed(2));
        calculateCartAmount();
    });

    $("#cartListContainer").on('click', ".couponPerItemCancel", function () {
        id = parseInt($(this).data("id"));
        $("#discPerItem_" + id).show();
        $("#discCouponPerItem_" + id).show();
        $("#discCouponPerItem_" + id).empty();
        quantity = parseInt($("#odrQuantity_" + id).text());
        price = parseFloat($("#perItemPrice_" + id).text()).toFixed(2) * quantity;
        if ($("#discPerUnit_" + id).length == 1)
        {
            discountAmount = parseFloat($("#discPerUnit_" + id).text());
            price = price - discountAmount;
        }
        else
        {
            $("#divPerItemTotal_" + id).empty();
        }
        $("#price_" + id).empty();
        $("#price_" + id).append(price.toFixed());
    });



    //change discount numpad to main numpad
    $(".keypad").on('click', '#btnBackInDiscount', function () {
        $(".keypad").empty();
        $(".keypad").load('/PointOfSale/Numpad?isDeliveryChargeAuto=' + IsDeliveryChargeAuto);
        totalNumber = [];
        discType = 0;
    });
    $(".keypad").on('click', '#btnDiscReset', function () {
        totalNumber = [];
        discType = 0;
        if ($("#discPerItem_" + liSelectedId).length == 1)
        {
            $("#discPerItem_" + liSelectedId).remove();
            quantity = parseInt($("#odrQuantity_" + liSelectedId).text());
            price = parseFloat($("#perItemPrice_" + liSelectedId).text()) * quantity;
            $("#price_" + liSelectedId).empty();
            $("#price_" + liSelectedId).append(price.toFixed(2));
        }
        else
        {
            $("#discountRow").remove();
            $("#totalAmountRow").remove();
        }
        totalPrice = 0.00;
        $(".subitemPrice").each(function () {
            totalPrice = totalPrice + parseFloat($(this).text());
        });
        $(".totalItemPrice").empty();
        $(".totalItemPrice").append(totalPrice.toFixed(2) + '<i class="taka">Tk</i>');

        $("#discFixed").prop("checked", true);
    });

    $(".keypad").on('click', '#discFixed', function () {

        if ($(this).prop('checked', false))
        {
            totalNumber = [];
            if (liSelectedId > 0)
            {
                if ($("#discount_" + liSelectedId).length == 1 && parseInt($("#discount_" + liSelectedId).data("offertype")) == 1)
                {
                    $("#discPerItem_" + liSelectedId).empty();
                    quantity = parseInt($("#odrQuantity_" + liSelectedId).text());
                    price = parseFloat($("#perItemPrice_" + liSelectedId).text()) * quantity;
                    $("#price_" + liSelectedId).empty();
                    $("#price_" + liSelectedId).append(price.toFixed(2));
                    $("#divPerItemTotal_" + liSelectedId).empty();
                    calculateCartAmount();
                }
            }
            else
            {
                if ($("#divDiscountAmount").length == 1 && parseInt($("#divDiscountAmount").data("offertype")) == 1) {
                    $("#tdDiscount").empty();
                    $("#divSubTotalBeforeDisc").empty();
                    calculateCartAmount();
                }
            }
        }
        $(this).prop('checked', true);
    });

    $(".keypad").on('click', '#discPercent', function () {

        if ($(this).prop('checked', false))
        {
            totalNumber = [];
            discType = 0;
            if (liSelectedId > 0) {
                if ($("#discount_" + liSelectedId).length == 1 && parseInt($("#discount_" + liSelectedId).data("offertype")) == 1) {
                    $("#discPerItem_" + liSelectedId).empty();
                    quantity = parseInt($("#odrQuantity_" + liSelectedId).text());
                    price = parseFloat($("#perItemPrice_" + liSelectedId).text()) * quantity;
                    $("#price_" + liSelectedId).empty();
                    $("#price_" + liSelectedId).append(price.toFixed(2));
                    $("#divPerItemTotal_" + liSelectedId).empty();
                    calculateCartAmount();
                }
            }
            else
            {
                if ($("#divDiscountAmount").length == 1 && parseInt($("#divDiscountAmount").data("offertype")) == 1) {
                    $("#tdDiscount").empty();
                    $("#divSubTotalBeforeDisc").empty();
                    calculateCartAmount();
                }
            }
        }
        $(this).prop('checked', true);
    });

    //*****************************Quantity, Price Change, Refund****************************************//

    $(".keypad").on('click', '.letter', function () {
        number = $(this).text();
        totalNumber.push(number);
        number = parseInt(totalNumber.join(""));
        if (liSelectedId > 0)
        {
            if (numpadFunction == 1) // for quantity
            {
                quantity = number;
                if (orderId > 0)
                {
                    previousQ = $("#odrQuantity_" + liSelectedId).data("quantity");
                    if (quantity > previousQ)
                    {
                        alert("Sorry...You can't refund more than " + previousQ + " Items");
                        totalNumber = [];
                        return false;
                    }
                }
                isUnitWise = $("#cartItem_" + liSelectedId).data("isunitwise");
                if (isUnitWise == "True") {
                    alert("You can't add more this product to cart");
                    return false;
                }
                $("#odrQuantity_" + liSelectedId).empty();
                $("#odrQuantity_" + liSelectedId).append(quantity);
                itemPrice = parseFloat($("#perItemPrice_" + liSelectedId).text()).toFixed(2);
                price = quantity * itemPrice;
                if ($("#discPerItem_" + liSelectedId).length == 1) {
                    disCount = parseInt($("#discount_" + liSelectedId).text());
                    discType = parseInt($("#discPerItem_" + liSelectedId).data("disctype"));
                    if (orderId > 0) {
                        if (discType == 1) {
                            discPercent = parseFloat($("#discPerUnit_" + liSelectedId).text());
                            disCount = price * (discPercent / 100);
                            price = price - disCount;
                            $("#discount_" + liSelectedId).empty();
                            $("#discount_" + liSelectedId).append(disCount.toFixed(2));
                        }
                        else {
                            discPercent = parseFloat($("#discount_" + liSelectedId).text());
                            disCount = price * (discPercent / 100);
                            price = price - disCount;
                            $("#discPerUnit_" + liSelectedId).empty();
                            $("#discPerUnit_" + liSelectedId).append(disCount.toFixed(2));
                        }
                    }
                    else {
                        if (discType == 1) {
                            discountAmount = (disCount / price) * 100;
                            price = price - disCount;
                        }
                        else {
                            discountAmount = price * (disCount / 100);
                            price = price - discountAmount;
                        }
                        $("#discPerUnit_" + liSelectedId).empty();
                        $("#discPerUnit_" + liSelectedId).append(discountAmount.toFixed(2));
                    }
                }
                $("#price_" + liSelectedId).empty();
                $("#price_" + liSelectedId).append(price.toFixed(2));
                totalPrice = 0.00;
                $(".subitemPrice").each(function () {
                    totalPrice = totalPrice + parseFloat($(this).text());
                });
                $(".totalItemPrice").empty();
                $(".totalItemPrice").append(totalPrice.toFixed(2) + '<i class="taka">Tk</i>');

                if (orderId > 0)
                {
                    // if tax on actual amount
                    if (orderTaxRate > 0 && orderTaxFunc == 1) // taxfunc 1 for tax on actual amount
                    {
                        tax = totalPrice * (orderTaxRate / 100);
                        totalPrice = totalPrice + tax;
                        $("#taxAmount").empty();
                        $("#taxAmount").append(tax.toFixed(2));
                    }
                    //discount change
                    if ($("#discountRow").length == 1) {
                        discType = parseInt($("#discountRow").data("disctype"));
                        discountAmount = totalPrice * (orderDisPercentage / 100);
                        totalPrice = totalPrice - discountAmount;
                        if (discType == 1) {
                            $("#discAmount").empty();
                            $("#discAmount").append(discountAmount.toFixed(2));
                        }
                        else {
                            $("#discUnit").empty();
                            $("#discUnit").append('%(' + discountAmount.toFixed(2) + 'Tk)');
                        }
                        $("#totalAmount").empty();
                        $("#totalAmount").append(totalPrice.toFixed(2));
                    }
                    //tax change
                    if (orderTaxRate > 0) {
                        if (orderTaxFunc == 0) // 0 for tax on discounted amount
                        {
                            tax = totalPrice * (orderTaxRate / 100);
                            totalPrice = totalPrice + tax;
                            $("#taxAmount").empty();
                            $("#taxAmount").append(tax.toFixed(2));
                        }
                        $("#totalAmount").empty();
                        $("#totalAmount").append(totalPrice.toFixed(2));
                    }
                    refundAmount = orderTotalPrice - totalPrice;
                    if (refundAmount > 0)
                    {
                        $("#btnRefundPay").removeClass('disabled');
                        $("#btnPrint").removeClass('disabled');
                    }
                    if ($("#refundRow").length == 1) {
                        $("#divRefundAmount").empty();
                        $("#divRefundAmount").append(refundAmount.toFixed(2));
                    }
                    else {
                        $(".summaryTbl").append(' <tr class="totalCartPriceRow" id="refundRow">' +
                            '<td>Refund Amount</td>' +
                            '<td id="total">' +
                            '<div>' +
                            '<span id="divRefundAmount">' + refundAmount.toFixed(2) + '</span>Tk' +
                            '</div>' +
                            '</td>' +
                            '</tr >');
                    }
                }
                else
                {
                    calculateCartAmount();
                }
            }
            else if (numpadFunction == 6) // for price change
            {
                if ($("#perItemPrice_" + liSelectedId).data("ispricechangeallow") == true)
                {
                    itemPrice = number;
                    $("#perItemPrice_" + liSelectedId).empty();
                    $("#perItemPrice_" + liSelectedId).append(itemPrice);
                    quantity = parseInt($("#odrQuantity_" + liSelectedId).text());
                    price = quantity * itemPrice;
                    if ($("#discPerItem_" + liSelectedId).length == 1) {
                        disCount = parseInt($("#discount_" + liSelectedId).text());
                        discType = parseInt($("#discPerItem_" + liSelectedId).data("disctype"));
                        if (discType == 1) {
                            discountAmount = (disCount / price) * 100;
                            price = price - disCount;
                        }
                        else {
                            discountAmount = price * (disCount / 100);
                            price = price - discountAmount;
                        }
                        $("#discPerUnit_" + liSelectedId).empty();
                        $("#discPerUnit_" + liSelectedId).append(discountAmount.toFixed(2));
                    }
                    $("#price_" + liSelectedId).empty();
                    $("#price_" + liSelectedId).append(price.toFixed(2));

                    calculateCartAmount();
                }
                else {
                    alert("Price change not allow for this product");
                }
            }
        }
        else {
            alert("Please select a product in cart list.");
        }
    });
    //**************product refund ******************
    $(".keypad").on('click', '#btnRefundPay', function () {

        @*orderProducts = [];
        id = 0;
        $(".singleCartItem").each(function ()
        {
            id = $(this).data("id");
            productId = parseInt($(this).data("productid"));

            disCount = 0;
            discType = 0;
            discPercent = 0;
            if ($("#discPerItem_" + id).length == 1)
            {
                discType = parseInt($("#discPerItem_" + id).data("disctype"));
                if (discType == 1) //discount fixed
                {
                    discPercent = parseFloat($("#discPerUnit_" + id).text());
                    disCount = parseFloat($("#discount_" + id).text());
                }
                else {
                    disCount = parseFloat($("#discPerUnit_" + id).text());
                    discPercent = parseFloat($("#discount_" + id).text());
                }
            }
            orderProducts.push({
                ProductId: productId,
                Quantity: parseInt($("#odrQuantity_" + id).text()),
                PerItemPrice: parseFloat($("#perItemPrice_" + id).text()).toFixed(2),
                Price: parseFloat($("#price_" + id).text()).toFixed(2),
                Discount: disCount,
                DiscountPercent: discPercent,
                DiscType: discType
            });
        });

        var model = {
            OrderId : orderId,
            OrderProducts: orderProducts
        };
        $("#divCheckoutWin").empty();
        $("#divCheckoutWin").kendoWindow({
                actions: ["Close"],
                draggable: false,
                modal: true,
                visible: false,
                title: 'Refund Pay',
                resizable: false
            });
        var refundPayWin = $("#divCheckoutWin").data("kendoWindow");
        refundPayWin.refresh({ url: '@Url.Action("RefundPay", "PointOfSale")', type: "POST", data: model });
        refundPayWin.center().open().maximize();*@

        totalPrice = 0.00;
        $(".subitemPrice").each(function () {
            totalPrice = totalPrice + parseFloat($(this).text());
        });
        subTotalPrice = totalPrice;
        if (totalPrice == 0) {
            //alert("Cart is Empty...");
            $("#divCheckoutWin").empty();
            $("#divCheckoutWin").kendoWindow({
                actions: [],
                draggable: false,
                modal: true,
                visible: false,
                title: 'Refund pay',
                resizable: false,
            });
            var refundWin = $("#divCheckoutWin").data("kendoWindow");
            refundWin.refresh('@Url.Action("RefundPay", "PointOfSale")?orderId=' + orderId);
            refundWin.center().open().maximize();
        }
        else
        {
            orderProducts = [];
            id = 0;
            totalPoints = 0;
            $(".singleCartItem").each(function () {
                id = parseInt($(this).data("id"));
                productId = parseInt($(this).data("productid"));

                disCount = 0;
                discType = 0;
                discPercent = 0;

                if ($("#discPerItem_" + id).length == 1) {
                    discType = parseInt($("#discPerItem_" + id).data("disctype"));
                    if (discType == 1) //discount fixed
                    {
                        discPercent = parseFloat($("#discPerUnit_" + id).text());
                        disCount = parseFloat($("#discount_" + id).text());
                    }
                    else {
                        disCount = parseFloat($("#discPerUnit_" + id).text());
                        discPercent = parseFloat($("#discount_" + id).text());
                    }
                }

                // if borrow from another shop
                isBorrow = false;
                if ($("#checkBorrow_" + id).is(":checked")) {
                    isBorrow = true;
                }
                //service
                isAfterSaleService = false;
                serviceDays = 0;
                serviceName = "";
                if ($("#service_" + id).length == 1) {
                    isAfterSaleService = true;
                    serviceDays = parseInt($("#service_" + id).text());
                    serviceName = $("#service_" + id).data("servicename");
                }
                //points
                isPointBased = false;
                points = 0;
                if ($("#points_" + id).length == 1) {
                    isPointBased = true;
                    points = parseInt($("#points_" + id).text());
                    totalPoints = totalPoints + points;
                }

                isUniqueItem = false;
                serialNumber = "";
                if ($("#serialNumber_" + id).length == 1) {
                    serialNumber = $("#serialNumber_" + id).text();
                    isUniqueItem = true;
                }
                orderProducts.push({
                    ProductId: productId,
                    ProductName: $(this).data("productname"),
                    TransactionType: 1,
                    Quantity: parseFloat($("#odrQuantity_" + id).text()).toFixed(2),
                    PerItemPrice: parseFloat($("#perItemPrice_" + id).text()).toFixed(2),
                    Price: parseFloat($("#price_" + id).text()).toFixed(2),
                    Discount: disCount,
                    DiscType: discType,
                    IsBorrow: isBorrow,
                    IsAfterSaleService: isAfterSaleService,
                    ServiceDays: serviceDays,
                    ServiceName: serviceName,
                    IsPointBased: isPointBased,
                    Points: points,
                    IsUniqueItem: isUniqueItem,
                    SerialNumber: serialNumber
                });
            });

            discType = 0;
            discountAmount = 0;
            tax = 0;
            // if tax on actual amount
            if (orderTaxRate > 0 && orderTaxFunc == 1) // taxfunc 1 for tax on actual amount
            {
                tax = totalPrice * (orderTaxRate / 100);
                totalPrice = totalPrice + tax;
            }
            //discount change
            if ($("#discountRow").length == 1) {
                discType = parseInt($("#discountRow").data("disctype"));
                discountAmount = totalPrice * (orderDisPercentage / 100);
                totalPrice = totalPrice - discountAmount;
            }
            //tax change
            if (orderTaxRate > 0) {
                if (orderTaxFunc == 0) // 0 for tax on discounted amount
                {
                    tax = totalPrice * (orderTaxRate / 100);
                    totalPrice = totalPrice + tax;
                }
            }

            var model =
            {
                InvoiceNo: $("#divOrderNo").text(),
                CustomerId: clientId,
                CustomerName: customerName,
                IsCreditAllow: IsCreditAllow,
                TaxPercent: orderTaxRate,
                DiscountPercent: orderDisPercentage,
                SubTotalPrice: subTotalPrice.toFixed(2),
                Tax: tax,
                TaxFunc: orderTaxFunc,
                TotalPrice: totalPrice.toFixed(2),
                InvoiceTotal: orderTotalPrice,
                OrderProducts: orderProducts,
                Discount: discountAmount,
                DiscType: discType,
                TotalPoints: totalPoints,
                RefundAmount: refundAmount.toFixed(2),
                PayAmount: extraPay.toFixed(2)
            };
            $("#divCheckoutWin").empty();
            $("#divCheckoutWin").kendoWindow({
                actions: [],
                draggable: false,
                modal: true,
                visible: false,
                title: 'Refund pay',
                resizable: false,
            });
            var refundWin = $("#divCheckoutWin").data("kendoWindow");
            refundWin.refresh({ url: '@Url.Action("RefundPay", "PointOfSale")', type: "POST", data: model });
            refundWin.center().open().maximize();
        }
    });

    //********************payment by cash ************************************
    @*$(".keypad").on('click', '#btnCash', function () {
        totalPrice = 0.00;
        $(".subitemPrice").each(function () {
            totalPrice = totalPrice + parseFloat($(this).text());
        });
        if (taxStatus == 1)
        {
            totalPrice = parseFloat($("#priceWithVat").text());
        }
        if ($("#discountRow").length == 1 && taxStatus == 0) {
            totalPrice = parseFloat($("#totalAmount").text());
        }

        if (totalPrice == 0)
        {
            alert("Cart is empty...");
        }
        else {
            $("#divCashWin").empty();
            $("#divCashWin").kendoWindow({
            actions: ["Close"],
            draggable: false,
            modal: true,
            visible: false,
            width: 600,
            height: 540,
            title: 'Cash',
            resizable: false
        });
        var cashWin = $("#divCashWin").data("kendoWindow");
        cashWin.refresh('@Url.Action("Cash", "PointOfSale")?totalPrice=' + totalPrice);
        cashWin.center().open();
        }
    });*@
    //*************************payment by card ***********************************

    @*$(".keypad").on('click', '#btnCard', function () {
        totalPrice = 0.00;
        $(".subitemPrice").each(function () {
            totalPrice = totalPrice + parseFloat($(this).text());
        });
        if (taxStatus == 1) {
            totalPrice = parseFloat($("#priceWithVat").text());
        }
        if ($("#discountRow").length == 1 && taxStatus == 0) {
            totalPrice = parseFloat($("#totalAmount").text());
        }
        if (totalPrice == 0)
        {
            alert("Cart is empty...");
        }
        else {
            $("#divCardWin").empty();
            $("#divCardWin").kendoWindow({
            actions: ["Close"],
            draggable: false,
            modal: true,
            visible: false,
            width: 600,
            height: 277,
            title: 'Card',
            resizable: false
        });
        var cardWin = $("#divCardWin").data("kendoWindow");
        cardWin.refresh('@Url.Action("Card", "PointOfSale")?totalPrice=' + totalPrice);
        cardWin.center().open();
        }
    });*@
    @**********************************Payment***********************************************@

    $("#divCheckoutWin").on('click', '#btnPay', function () {
        orderAmount = parseFloat($("#divOrderAmountTotal").text());
        if (orderAmount == 0)
        {
            alert("Cart is empty.");
        }
        else
        {
            $(this).prop('disabled', true);
            orderProducts = [];
            id = 0;
            isPointItem = false;
            isServiceItem = false;
            totalPoints = 0;
            var isRefundAllow;
            $(".singleCartItem").each(function () {
                id = parseInt($(this).data("id"));
                productId = parseInt($(this).data("productid"));
                if (id == 0)
                {
                    transactionType = parseInt($(this).data("type"));
                    if (transactionType == 2) // 2 for credit payment
                    {
                        orderProducts.push({
                            ProductId: 0,
                            ProductName: "Credit Payment",
                            TransactionType: transactionType,
                            Price: duePay,
                            IsRefundAllow: false
                        });
                    }
                    else if (transactionType == 3) // 3 for debit account refill
                    {
                        orderProducts.push({
                            ProductId: 0,
                            ProductName: "Account Refill",
                            TransactionType: transactionType,
                            Price: debitRefill,
                            IsRefundAllow: false
                        });
                    }
                }
                else
                {
                    isRefundAllow = $(this).data("isrefundallow");
                    // if borrow from another shop
                    isBorrow = false;
                    associateId = 0;
                    if ($("#checkBorrow_" + id).is(":checked")) {
                        associateId = parseInt($("#checkBorrow_" + id).data("associateid"));
                        isBorrow = true;
                    }
                    //service
                    isAfterSaleService = false;
                    serviceDays = 0;
                    serviceTypeId = 0;
                    serviceName = "";
                    if ($("#service_" + id).length == 1) {
                        isAfterSaleService = true;
                        serviceDays = parseInt($("#service_" + id).text());
                        serviceName = $("#service_" + id).data("servicename");
                        serviceTypeId = $("#service_" + id).data("servicetypeid");
                        isServiceItem = true;
                    }
                    //points
                    isPointBased = false;
                    points = 0;
                    if ($("#points_" + id).length == 1) {
                        isPointBased = true;
                        points = parseInt($("#points_" + id).text());
                        isPointItem = true;
                        totalPoints = totalPoints + points;
                    }
                    isUniqueItem = false;
                    serialNumber = "";
                    if ($("#serialNumber_" + id).length == 1) {
                        serialNumber = $("#serialNumber_" + id).text();
                        isUniqueItem = true;
                    }

                    orderProducts.push({
                        ProductId: productId,
                        ProductName: $(this).data("productname"),
                        TransactionType: 1,
                        POItemId: $(this).data("poitemid"),
                        Quantity: parseFloat($("#odrQuantity_" + id).text()).toFixed(2),
                        PerItemPrice: parseFloat($("#perItemPrice_" + id).text()).toFixed(2),
                        PerItemTotalPrice: ($("#divPerItemTotalPrice_" + id).length == 1 ? parseFloat($("#divPerItemTotalPrice_" + id).text()) : 0),
                        Price: parseFloat($("#price_" + id).text()).toFixed(2),
                        //Discount
                        Discount: ($("#discount_" + id).length == 1 ? parseFloat($("#discount_" + id).text()) : 0),
                        DiscType: ($("#discount_" + id).length == 1 ? parseInt($("#discount_" + id).data("disctype")) : 0),
                        DiscountAmount: ($("#discPerUnit_" + id).length == 1 ? parseFloat($("#discPerUnit_" + id).text()) : 0),
                        DiscountId: ($("#discount_" + id).length == 1 ? parseInt($("#discount_" + id).data("offerid")) : 0),
                        //Coupon Discount
                        CouponDiscount: ($("#couponDiscount_" + id).length == 1 ? parseFloat($("#couponDiscount_" + id).text()) : 0),
                        CouponDiscType: ($("#couponDiscount_" + id).length == 1 ? parseInt($("#couponDiscount_" + id).data("disctype")) : 0),
                        CouponDiscAmount: ($("#CouponDiscPerUnit_" + id).length == 1 ? parseFloat($("#CouponDiscPerUnit_" + id).text()) : 0),
                        CouponDiscId: ($("#couponDiscount_" + id).length == 1 ? parseInt($("#couponDiscount_" + id).data("offerid")) : 0),
                        SubOfferId: ($("#couponDiscount_" + id).length == 1 ? parseInt($("#couponDiscount_" + id).data("subofferid")) : 0),
                        IsRefundAllow: isRefundAllow,
                        AssociateId: associateId,
                        IsBorrow: isBorrow,
                        IsAfterSaleService: isAfterSaleService,
                        ServiceDays: serviceDays,
                        ServiceName: serviceName,
                        ServiceTypeId: serviceTypeId,
                        IsPointBased: isPointBased,
                        Points: points,
                        IsUniqueItem: isUniqueItem,
                        SerialNumber: serialNumber
                    });
                }
            });

            tax = 0;
            deliveryCharge = 0;

            if ($("#taxAmount").length == 1) {
                tax = parseFloat($("#taxAmount").text());
            }

            if ($("#divDeliveryCharge").length == 1) {
                deliveryCharge = parseFloat($("#divDeliveryCharge").text());
            }

            var payments = [];
            $(".amountInTransaction").each(function () {
                if ($(this).data("id") == 1) //cash
                {
                    payments.push({
                        PaymentTypeId: 1,
                        PaymentBodyId: parseInt($(this).data("cashbodyid")),
                        AmountPaid: cashAmount
                    });
                }
                else if ($(this).data("id") == 2) // card
                {
                    payments.push({
                        PaymentTypeId: 2,
                        PaymentBodyId: parseInt($(this).data("cardbodyid")),
                        AmountPaid: parseFloat($(this).data("cardamount")),
                        TransactionNo: $(this).data("transactionno")
                    });
                }
                else if ($(this).data("id") == 3) // bkash
                {
                    payments.push({
                        PaymentTypeId: 3,
                        PaymentBodyId: parseInt($(this).data("bkashbodyid")),
                        AmountPaid: parseFloat($(this).data("bkashamount")),
                        TransactionNo: $(this).data("transactionno")
                    });
                }
                else if ($(this).data("id") == 4) //debit
                {
                    payments.push({
                        PaymentTypeId: 8,
                        PaymentBodyId: 17,
                        AmountPaid: parseFloat($(this).data("debitamount")),
                    });
                }
                else if ($(this).data("id") == 5) //credit
                {
                    payments.push({
                        PaymentTypeId: 7,
                        PaymentBodyId: 16,
                        AmountPaid: parseFloat($(this).data("creditamount")),
                    });
                }
            });
            if (document.getElementById("returnRow").style.display == "") {
                returnAmount = parseFloat($("#returnAmount").text());
            }
            else {
                returnAmount = 0;
            }
            $.ajax({
                url: '/PointOfSale/OrderSave',
                type: "POST",
                data: JSON.stringify({
                    OrderAmount: orderAmount.toFixed(2),
                    InvoiceDiscount: ($("#orderAmountDiscount").length == 1 ? parseFloat($("#orderAmountDiscount").text()).toFixed(2) : 0),
                    DiscountItem: parseFloat($("#divDiscItemTotal").text()).toFixed(2),
                    SubTotalPrice: parseFloat($("#divSubTotal").text()).toFixed(2),
                    SubTotalBeforeDiscount: ($("#subTotalBeforeDisc").length == 1 ? parseFloat($("#subTotalBeforeDisc").text()).toFixed(2) : 0),
                    //Discount
                    Discount: ($("#divDiscountAmount").length == 1 ? parseFloat($("#divDiscountAmount").text()).toFixed(2) : 0),
                    DiscType: ($("#divDiscountAmount").length == 1 ? parseInt($("#divDiscountAmount").data("disctype")) : 0),
                    DiscountAmount: ($("#divDiscValue").length == 1 ? parseFloat($("#divDiscValue").text()) : 0),
                    DiscountWorkAmount: ($("#divInvoiceDiscount").length == 1 ? parseFloat($("#divInvoiceDiscount").text()) : 0),
                    DiscountId: ($("#divDiscountAmount").length == 1 ? parseInt($("#divDiscountAmount").data("offerid")) : 0),
                    //Coupon Discount
                    CouponDiscount: ($("#divCouponDiscAmount").length == 1 ? parseFloat($("#divCouponDiscAmount").text()).toFixed(2) : 0),
                    CouponDiscType: ($("#divCouponDiscAmount").length == 1 ? parseInt($("#divCouponDiscAmount").data("disctype")) : 0),
                    CouponDiscountAmount: ($("#divCouponDiscValue").length == 1 ? parseFloat($("#divCouponDiscValue").text()) : 0),
                    CouponDiscWorkAmount: ($("#divCouponInvoiceDiscount").length == 1 ? parseFloat($("#divCouponInvoiceDiscount").text()) : 0),
                    CouponDiscId: ($("#divCouponDiscAmount").length == 1 ? parseInt($("#divCouponDiscAmount").data("offerid")) : 0),
                    //Tax
                    Tax: tax,
                    TaxPercent: taxRate,
                    TaxFunc: taxFunc,
                    TotalPrice: parseFloat($("#divTotalAmount").text()).toFixed(2),
                    //Delivery Charge
                    DeliveryCharge: deliveryCharge.toFixed(2),
                    DelChargeType: ($("#divdelChargeType").length == 1 ? parseInt($("#divdelChargeType").data("delchargetype")) : 0),
                    DeliveryChargeAmount: ($("#divdelChargeType").length == 1 ? parseFloat($("#divDeliveryChargeAmount").text()).toFixed(2) : 0),
                    DelChargeBeforeDisc: ($("#deliveryChargeBeforeDisc").length == 1 ? parseFloat($("#deliveryChargeBeforeDisc").text()).toFixed(2) : 0),
                    DeliveryChargeId: ($("#divdelChargeType").length == 1 ? parseInt($("#divdelChargeType").data("deliveryid")) : 0),

                    //Delivery Charge Discount
                    DelChargeDiscPercent: ($("#divDelChargeDiscPercent").length == 1 ? parseInt($("#divDelChargeDiscPercent").text()) : 0),
                    DeliveryChargeDiscount: ($("#divDelChargeDiscount").length == 1 ? parseFloat($("#divDelChargeDiscount").text()) : 0),
                    DelDiscId: ($("#divDelChargeDiscPercent").length == 1 ? parseInt($("#divDelChargeDiscPercent").data("offerid")) : 0),
                    //Coupon Delivery charge discount
                    CouponDelChargeDiscPercent: ($("#divCouponDelChargeDiscPercent").length == 1 ? parseInt($("#divCouponDelChargeDiscPercent").text()) : 0),
                    CouponDelChargeDiscount: ($("#divCouponDelChargeDiscount").length == 1 ? parseFloat($("#divCouponDelChargeDiscount").text()) : 0),
                    CouponDelivId: ($("#divCouponDelChargeDiscPercent").length == 1 ? parseInt($("#divCouponDelChargeDiscPercent").data("offerid")) : 0),

                    InvoiceAmount: parseFloat($("#divInvoiceAmount").text()).toFixed(2),

                    OrderProducts: orderProducts,
                    Payments: payments,
                    //coupon
                    CreditAmount: creditAmount,
                    CustomerId: clientId,
                    MethodId: methodId,
                    ReturnAmount: returnAmount,
                    IsServiceItems: isServiceItem,
                    IsPointItems: isPointItem,
                    TotalPoints: totalPoints,
                    PurchaseOrderId: purchaseOrderId,
                    OfferId: ($("#divCouponRow").length == 1 ? parseInt($("#divCouponRow").data("offerid")) : 0),
                    CreatedBy: userId
                }),
                contentType: 'application/json',
                success: function (data) {
                    if (data == "error")
                    {
                        alert("Save error...");
                    }
                    else
                    {
                        var data = "orderId=" + data.OrderId;
                        window.location.href = '/PointOfSale/OrderVoucher?q=' + getDataEncrypted(data);
                    }
                }
            });
        }
    });

    //***************************************Refund pay *************************************************
    $("#divCheckoutWin").on('click', "#btnRefundPaySave", function () {
         totalPrice = 0.00;
        $(".subitemPrice").each(function () {
            totalPrice = totalPrice + parseFloat($(this).text());
        });
        subTotalPrice = totalPrice;
        if (totalPrice == 0) {
            alert("Cart is Empty...");
        }
        else
        {
            orderProducts = [];
            id = 0;
            totalPoints = 0;
            $(".singleCartItem").each(function () {
                id = parseInt($(this).data("id"));
                productId = parseInt($(this).data("productid"));

                isRefundAllow = $(this).data("isrefundallow");
                disCount = 0;
                discType = 0;
                discPercent = 0;
                if ($("#discPerItem_" + id).length == 1) {
                    discType = parseInt($("#discPerItem_" + id).data("disctype"));
                    if (discType == 1) //discount fixed
                    {
                        discPercent = parseFloat($("#discPerUnit_" + id).text());
                        disCount = parseFloat($("#discount_" + id).text());
                    }
                    else {
                        disCount = parseFloat($("#discPerUnit_" + id).text());
                        discPercent = parseFloat($("#discount_" + id).text());
                    }
                }
                // if borrow from another shop
                isBorrow = false;
                associateId = 0;
                if ($("#checkBorrow_" + id).is(":checked")) {
                    associateId = parseInt($("#checkBorrow_" + id).data("associateid"));
                    isBorrow = true;
                }
                //service
                isAfterSaleService = false;
                serviceDays = 0;
                serviceTypeId = 0;
                serviceName = "";
                if ($("#service_" + id).length == 1) {
                    isAfterSaleService = true;
                    serviceDays = parseInt($("#service_" + id).text());
                    serviceName = $("#service_" + id).data("servicename");
                    serviceTypeId = $("#service_" + id).data("servicetypeid");
                    isServiceItem = true;
                }
                //points
                isPointBased = false;
                points = 0;
                if ($("#points_" + id).length == 1) {
                    isPointBased = true;
                    points = parseInt($("#points_" + id).text());
                    isPointItem = true;
                    totalPoints = totalPoints + points;
                }
                isUniqueItem = false;
                serialNumber = "";
                if ($("#serialNumber_" + id).length == 1) {
                    serialNumber = $("#serialNumber_" + id).text();
                    isUniqueItem = true;
                }

                poItemId = 0;
                if ($(this).data("poitemid") > 0)
                {
                    poItemId = $(this).data("poitemid");
                }

                orderProducts.push({
                    ProductId: productId,
                    DistributeId: $(this).data("distributeid"),
                    ProductName: $(this).data("productname"),
                    POItemId: poItemId,
                    TransactionType: 1,
                    Quantity: parseInt($("#odrQuantity_" + id).text()),
                    PerItemPrice: parseFloat($("#perItemPrice_" + id).text()).toFixed(2),
                    Price: parseFloat($("#price_" + id).text()).toFixed(2),
                    Discount: disCount,
                    DiscType: discType,
                    IsRefundAllow: isRefundAllow,
                    AssociateId: associateId,
                    IsBorrow: isBorrow,
                    IsAfterSaleService: isAfterSaleService,
                    ServiceDays: serviceDays,
                    ServiceName: serviceName,
                    ServiceTypeId: serviceTypeId,
                    IsPointBased: isPointBased,
                    Points: points,
                    IsUniqueItem: isUniqueItem,
                    SerialNumber: serialNumber
                });
            });

            discType = 0;
            discountAmount = 0;
            tax = 0;
            // if tax on actual amount
            if (orderTaxRate > 0 && orderTaxFunc == 1) // taxfunc 1 for tax on actual amount
            {
                tax = totalPrice * (orderTaxRate / 100);
                totalPrice = totalPrice + tax;
            }
            //discount change
            if ($("#discountRow").length == 1) {
                discType = parseInt($("#discountRow").data("disctype"));
                discountAmount = totalPrice * (orderDisPercentage / 100);
                totalPrice = totalPrice - discountAmount;
            }
            //tax change
            if (orderTaxRate > 0) {
                if (orderTaxFunc == 0) // 0 for tax on discounted amount
                {
                    tax = totalPrice * (orderTaxRate / 100);
                    totalPrice = totalPrice + tax;
                }
            }
        }
        var payments = [];
        $(".amountInTransaction").each(function () {
            if ($(this).data("id") == 1) //cash
            {
                payments.push({
                    PaymentTypeId: 1,
                    PaymentBodyId: parseInt($(this).data("cashbodyid")),
                    AmountPaid: cashAmount
                });
            }
            else if ($(this).data("id") == 2) // card
            {
                payments.push({
                    PaymentTypeId: 2,
                    PaymentBodyId: parseInt($(this).data("cardbodyid")),
                    AmountPaid: parseFloat($(this).data("cardamount")),
                    TransactionNo: $(this).data("transactionno")
                });
            }
            else if ($(this).data("id") == 3) // bkash
            {
                payments.push({
                    PaymentTypeId: 3,
                    PaymentBodyId: parseInt($(this).data("bkashbodyid")),
                    AmountPaid: parseFloat($(this).data("bkashamount")),
                    TransactionNo: $(this).data("transactionno")
                });
            }
            else if ($(this).data("id") == 4) //debit
            {
                payments.push({
                    PaymentTypeId: 8,
                    PaymentBodyId: 17,
                    AmountPaid: parseFloat($(this).data("debitamount")),
                });
            }
            else if ($(this).data("id") == 5) //credit
            {
                payments.push({
                    PaymentTypeId: 7,
                    PaymentBodyId: 16,
                    AmountPaid: parseFloat($(this).data("creditamount")),
                });
            }
        });
        if (document.getElementById("returnRow").style.display == "") {
            returnAmount = parseFloat($("#returnAmount").text());
        }
        else {
            returnAmount = 0;
        }

         $.ajax({
            url: '@Url.Action("OrderRefundSave", "PointOfSale")',
            type: "POST",
            data: JSON.stringify({
                OrderId: orderId,
                SalesmanId: userId,
                TaxPercent: orderTaxRate,
                DiscountPercent: orderDisPercentage,
                SubTotalPrice: subTotalPrice.toFixed(2),
                Tax: tax,
                TaxFunc: orderTaxFunc,
                TotalPrice: totalPrice.toFixed(2),
                OrderProducts: orderProducts,
                Discount: discountAmount,
                DiscType: discType,
                MethodId: methodId,
                Payments: payments,
                CreditAmount: creditAmount,
                ReturnAmount: returnAmount,
                IsServiceItems: isServiceItem,
                IsPointItems: isPointItem,
                TotalPoints: totalPoints,
                RefundAmount: refundAmount.toFixed(2),
                PayAmount: extraPay.toFixed(2)
            }),
            contentType: 'application/json',
            success: function (data) {
                if (data = "success")
                {
                    window.location.reload();
                }
                else {
                    alert("Save error...");
                }
            }
        });
    });
    //*************************************************Offer ***********************************
    // Get offer from cart item
    $("#btnOfferFromCartItem").click(function () {
        orderProducts = [];
        $(".singleCartItem").each(function () {
            id = $(this).data("id");
            productId = parseInt($(this).data("productid"));
            orderProducts.push({
                ProductId: productId,
                Quantity: parseInt($("#odrQuantity_" + id).text()),
            });
        });

        $("#divGetOfferWin").empty();
        $("#divGetOfferWin").kendoWindow({
            actions: ["Close"],
            draggable: false,
            modal: true,
            visible: false,
            width: 767,
            height: 288,
            title: 'Offer',
            resizable: false,
            close: onWindowClose
        });
        var getOfferWin = $("#divGetOfferWin").data("kendoWindow");
        getOfferWin.refresh({ url: '@Url.Action("GetOffer", "PointOfSale")', type: "POST", data: { model: orderProducts } });
        getOfferWin.center().open();
        document.documentElement.style.overflow = 'hidden';  // firefox, chrome
        document.body.scroll = "no";
    });

    $("#btnOffer").click(function () {
        $(this).addClass("selected");
        $("#btnSearchByText").removeClass("selected");
        $("#btnSearchBySKU").removeClass("selected");
        $("#btnOrders").removeClass("selected");
        $("#btnAvailability").removeClass("selected");

        $("#productList").empty();
        $("#productList").append('<div class="loading_partial"></div>');
        $("#productList").load('@Url.Action("OfferList", "PointOfSale")?isInPOS=true');
        //$("#divSearchStringText").hide();
        //$("#divSearchStringSKU").hide();
        //$("#divSearchStringOrder").hide();
        //$("#divSearchStringAvailability").show();
    });

    //customer dropdown
    function onChangeCustomer()
    {
        $("#cartListContainer").empty();
        $("#emptyCartPlaceholder").show();

        resetCart();

        liSelectedId = 0;
        totalNumber = [];
        $(".keypad").empty();
        $(".keypad").load('/PointOfSale/Numpad?isDeliveryChargeAuto=' + IsDeliveryChargeAuto);
        totalNumber = [];
        discType = 0;
        if (orderId > 0)
        {
            $("#btnSearchBySKU").click();
            $("#refundRow").remove();
            $("#orderReload").hide();
            $("#btnPaymentInfo").hide();
            $("#btnRefundInfo").hide();
            $("#productList").children().prop('disabled', false);
            $("#orderTitle").empty();
            $("#orderTitle").append('Your Order');
            $("#btnSearchByText").prop('disabled', false);
            $("#btnSearchBySKU").prop('disabled', false);
            $("#btnAvailability").prop('disabled', false);
            orderId = 0;
        }
        purchaseOrderId = 0;
        $("#productList").empty();
        $("#productList").append('<div class="loading_partial"></div>');
        $("#productList").load('@Url.Action("ProductList","PointOfSale")');

        var selectedOne = "";
        selectedOne = this.value();
        if (selectedOne.length > 0)
        {
            clientId = parseInt(selectedOne);
             $.ajax({
                url: '@Url.Action("GetCustomerByCardNoOrId", "PointOfSale")',
                type: 'Get',
                data: { id: clientId },
                success: function (data)
                {
                    if (data == "error")
                    {
                        alert("Not Found...");
                    }
                    else
                    {
                        $("#divDebitAndCredit").show();
                        $("#divPurchaseOrder").show();
                        $(data).each(function (index, item) {
                            customerName = item.Name;
                            if (item.CreditAmount > 0)
                            {
                                $("#btnCreditPayment").show();
                            }
                            else
                            {
                                $("#btnCreditPayment").hide();
                            }

                            if (item.AvailableDebit < item.DebitLimit)
                            {
                                $("#btnAccountRefill").show();
                            }
                            else
                            {
                                $("#btnAccountRefill").hide();
                            }
                            $('#PurchaseOrderDropdown').data('kendoDropDownList').value("");
                            $('#PurchaseOrderDropdown').data('kendoDropDownList').dataSource.read();
                        });
                    }
                },
                error: function ()
                {
                    alert("Not Found...");
                }
            });
        }
        else
        {
            $('#emptyCartBtn').click();



            //clientId = 0;
            //customerName = "";
            //$("#divDebitAndCredit").hide();

            //purchaseOrderId = 0;
            //poItemId = 0;
            //purchaseOrderQty = 0;
            //$("#divPurchaseOrder").hide();
            //$('#PurchaseOrderDropdown').data('kendoDropDownList').value("");
        }
    }

    //Credit payment
    $("#btnCreditPayment").click(function () {
        $("#divCreditPaymentWin").empty();
        $("#divCreditPaymentWin").kendoWindow({
            actions: ["Close"],
            draggable: false,
            modal: true,
            visible: false,
            width: 732,
            height: 279,
            title: 'Credit Payment',
            resizable: false,
            close: onWindowClose
        });
        var creditPaymentWin = $("#divCreditPaymentWin").data("kendoWindow");
        creditPaymentWin.refresh('/PointOfSale/CreditPayment?customerId=' + clientId);
        creditPaymentWin.center().open();
        document.documentElement.style.overflow = 'hidden';  // firefox, chrome
        document.body.scroll = "no";
    });

    //debit refill
    $("#btnAccountRefill").click(function () {
        $("#divDebitRefillWin").empty();
        $("#divDebitRefillWin").kendoWindow({
            actions: ["Close"],
            draggable: false,
            modal: true,
            visible: false,
            width: 732,
            height: 279,
            title: 'Debit Refill',
            resizable: false,
            close: onWindowClose
        });
        var debitRefillWin = $("#divDebitRefillWin").data("kendoWindow");
        debitRefillWin.refresh('/PointOfSale/DebitRefill?customerId=' + clientId);
        debitRefillWin.center().open();
        document.documentElement.style.overflow = 'hidden';  // firefox, chrome
        document.body.scroll = "no";
    });

    //set product associate info
    $("#cartListContainer").on("click", ".checkBorrow", function () {
        id = parseInt($(this).data("id"));
        if ($("#checkBorrow_" + id).is(":checked"))
        {
            $("#divAssociateWin").empty();
            $("#divAssociateWin").kendoWindow({
                actions: [],
                draggable: false,
                modal: true,
                visible: false,
                width: 732,
                height: 185,
                title: 'Associate',
                resizable: false,
                close: onWindowClose
            });
            var associateWin = $("#divAssociateWin").data("kendoWindow");
            associateWin.refresh('/PointOfSale/SetAssociate?id=' + id);
            associateWin.center().open();
            document.documentElement.style.overflow = 'hidden';  // firefox, chrome
            document.body.scroll = "no";
        }
        else
        {
            $("#checkBorrow_" + id).attr('data-associateid', 0);
        }
    });

    //***********************************Purchase order dropdown *******************************************
    function additionalDataForPurchaseOrder()
    {
        return {
            customerId: clientId
        }
    }

    function onChangePurchaseOrder()
    {
        $("#cartListContainer").empty();
        $("#emptyCartPlaceholder").show();

        resetCart();

        @*liSelectedId = 0;
        totalNumber = [];
        $(".keypad").empty();
        $(".keypad").load('/PointOfSale/Numpad?isDeliveryChargeAuto=' + IsDeliveryChargeAuto);
        totalNumber = [];
        discType = 0;
        purchaseOrderId = 0;
        poItemId = 0;
        purchaseOrderQty = 0;
        $("#productList").empty();
        $("#productList").append('<div class="loading_partial"></div>');
        $("#productList").load('@Url.Action("ProductList","PointOfSale")');

        $("#divDebitAndCredit").show();*@

        if (this.value().length > 0)
        {
            purchaseOrderId = parseInt(this.value());
            $("#productList").empty();
            $("#productList").append('<div class="loading_partial"></div>');
            $("#productList").load('/PointOfSale/PurchaseOrderProductList?purchaseId=' + purchaseOrderId);

            $("#divDebitAndCredit").hide();
        }
        else
        {
            liSelectedId = 0;
            totalNumber = [];
            $(".keypad").empty();
            $(".keypad").load('/PointOfSale/Numpad?isDeliveryChargeAuto=' + IsDeliveryChargeAuto);
            totalNumber = [];
            discType = 0;
            purchaseOrderId = 0;
            poItemId = 0;
            purchaseOrderQty = 0;
            $("#productList").empty();
            $("#productList").append('<div class="loading_partial"></div>');
            $("#productList").load('@Url.Action("ProductList","PointOfSale")');

            $("#divDebitAndCredit").show();
        }
    }

    //******************************Grid view*******************************************
    $("#btnGridView").click(function () {

        if (purchaseOrderId > 0)
        {
            $("#productList").empty();
            $("#productList").append('<div class="loading_partial"></div>');
            $("#productList").load('/PointOfSale/PurchaseOrderProductList?purchaseId=' + purchaseOrderId);
        }
        else
        {
            $("#productList").empty();
            $("#productList").append('<div class="loading_partial"></div>');
            $("#productList").load('@Url.Action("ProductList","PointOfSale")');
        }
    });

    //******************************List View*******************************************
    $("#btnListView").click(function () {
        if (purchaseOrderId > 0)
        {
            $("#productList").empty();
            $("#productList").append('<div class="loading_partial"></div>');
            $("#productList").load('/PointOfSale/PurchaseOrderProductList?purchaseId=' + purchaseOrderId + '&isListView=true');
        }
        else
        {
            $("#productList").empty();
            $("#productList").append('<div class="loading_partial"></div>');
            $("#productList").load('@Url.Action("ProductList","PointOfSale")?isListView=true');
        }
    });

    //**********************************Delivery Charge**************************************
    $(".keypad").on('click', '#btnDeliveryCharge', function () {
        totalPrice = parseFloat($("#divSubTotal").text());
        if (duePay > 0) {
            totalPrice = totalPrice - duePay;
        }
        //if debit account refill
        if (debitRefill > 0) {
            totalPrice = totalPrice - debitRefill;
        }

        IsDeliveryChargeAuto = 1;

        $("#divDelChargeBeforeDisc").empty();
        $("#tdDelivChargeDisc").empty();
        if (orderAmount > 0) {
            $.ajax({
                url: '/PointOfSale/CheckDeliveryCharge',
                type: 'GET',
                data: { totalPrice: totalPrice },
                success: function (data) {
                    if (data == "error") {
                        alert("Delivery charge Check error.");
                        $("#divDeliveryChargeAmount").empty();
                        $("#divDeliveryChargeAmount").append(0);
                        $("#divdelChargeType").empty();
                        $("#divdelChargeType").append('%');
                        $("#divdelChargeType").attr('data-delchargetype', '0');
                        $("#divdelChargeType").attr('data-deliveryid', '0');
                        $("#divDeliveryCharge").empty();
                        $("#divDeliveryCharge").append(0);
                    }
                    else
                    {
                        totalPrice = totalPrice + data.deliveryCharge;

                        if (data.IsPercentile) {

                            $("#divDeliveryChargeAmount").empty();
                            $("#divDeliveryChargeAmount").append(data.Amount);
                            $("#divdelChargeType").empty();
                            $("#divdelChargeType").append('%');
                            $("#divdelChargeType").attr('data-delchargetype', '0');
                            $("#divDeliveryCharge").empty();
                            $("#divDeliveryCharge").append(data.deliveryCharge.toFixed(2));
                        }
                        else
                        {
                            $("#divDeliveryChargeAmount").empty();
                            $("#divDeliveryChargeAmount").append(data.Amount);
                            $("#divdelChargeType").empty();
                            $("#divdelChargeType").append('Tk');
                            $("#divdelChargeType").attr('data-delchargetype', '1');
                            $("#divDeliveryCharge").empty();
                            $("#divDeliveryCharge").append(data.deliveryCharge.toFixed(2));
                        }
                        $("#divdelChargeType").attr('data-deliveryid', data.DeliveryId);

                        //*******************Delivery charge discount**********************
                        if (data.discountDeliveryCharge > 0) {
                            $("#divDelChargeBeforeDisc").append(
                                ' | <span id="deliveryChargeBeforeDisc">' + data.deliveryCharge.toFixed(2) + '</span>Tk'
                            );
                            $("#tdDelivChargeDisc").append(
                                'Discount(<span id="divDelChargeDiscPercent" data-offertype="2" data-offerid="' + data.delDiscId +'">' + data.discountDeliveryPercentage + '</span>%) | ' +
                                '-<span id="divDelChargeDiscount">' + data.discountDeliveryCharge.toFixed(2) + '</span>Tk'
                            );

                            $("#divDeliveryCharge").empty();
                            $("#divDeliveryCharge").append((data.deliveryCharge - data.discountDeliveryCharge).toFixed(2));
                            totalPrice = totalPrice - data.discountDeliveryCharge;
                        }

                        if (duePay > 0) {
                            totalPrice = totalPrice + duePay;
                        }
                        //if debit account refill
                        if (debitRefill > 0) {
                            totalPrice = totalPrice + debitRefill;
                        }

                        $("#divInvoiceAmount").empty();
                        $("#divInvoiceAmount").append(totalPrice.toFixed(2));
                    }
                }
            });
        }
        else
        {
            alert("Cart is Empty...");
        }
    });

    //********************Coupon code cancel************************************
    function divEnable()
    {
        $("#divAll *").prop('disabled', false);
        $("#divLeft").removeClass('blur');

        var customerDropdown = $("#CustomerDropdown").data("kendoDropDownList");
        customerDropdown.enable(true);

        var purchaseOrderDropdown = $("#PurchaseOrderDropdown").data("kendoDropDownList");
        purchaseOrderDropdown.enable(true);
    }

    $("#billSummaryContainer").on('click', '#btnAmountCouponCodeCancel', function () {
        $("#divCouponRow").empty();
        $("#divCouponRow").remove();
        $("#tdCouponDiscount").empty();
        $("#tdDiscount").show();
        divEnable();
        calculateCartAmount();
    });

    $("#billSummaryContainer").on('click', '#btnDelChargeCouponCodeCancel', function () {
        $("#divCouponRow").empty();
        $("#divCouponRow").remove();
        $("#tdDelivChargeDisc").show();
        $("#tdCouponDelivChargeDisc").empty();
        $("#tdCouponDelivChargeDisc").show();
        divEnable();
        calculateCartAmount();
    });

    $("#billSummaryContainer").on('click', '#btnProductCouponCodeCancel', function () {
        $("#divCouponRow").empty();
        $("#divCouponRow").remove();
        $(".couponPerItemCancel").each(function () {
            $(this).click();
        });
        divEnable();
        calculateCartAmount();
    });


    //********************Invoice info in short***********************
    $("#btnInvoiceInfo").click(function () {
        $("#divInvoiceInfo").empty();

        orderAmount = parseFloat($("#divOrderAmountTotal").text());
        totalPrice = parseFloat($("#divSubTotal").text());
        if (orderAmount == 0)
        {
            alert("Cart is empty.");
        }
        else
        {
            orderProducts = [];
            id = 0;
            $(".singleCartItem").each(function () {
                id = parseInt($(this).data("id"));
                productId = parseInt($(this).data("productid"));
                if (id == 0) {
                    transactionType = parseInt($(this).data("type"));
                    if (transactionType == 2) // 2 for credit payment
                    {
                        orderProducts.push({
                            ProductName: "Credit Payment",
                            TransactionType: transactionType,
                            Price: duePay,
                        });
                    }
                    else if (transactionType == 3) // 3 for debit account refill
                    {
                        orderProducts.push({
                            ProductName: "Account Refill",
                            TransactionType: transactionType,
                            Price: debitRefill,
                        });
                    }
                }
                else {
                    // if borrow from another shop
                    isBorrow = false;
                    if ($("#checkBorrow_" + id).is(":checked")) {
                        isBorrow = true;
                    }
                    //service
                    isAfterSaleService = false;
                    serviceDays = 0;
                    serviceName = "";
                    if ($("#service_" + id).length == 1) {
                        isAfterSaleService = true;
                        serviceDays = parseInt($("#service_" + id).text());
                        serviceName = $("#service_" + id).data("servicename");
                    }
                    //points
                    isPointBased = false;
                    points = 0;
                    if ($("#points_" + id).length == 1) {
                        isPointBased = true;
                        points = parseInt($("#points_" + id).text());
                        totalPoints = totalPoints + points;
                    }

                    isUniqueItem = false;
                    serialNumber = "";
                    if ($("#serialNumber_" + id).length == 1) {
                        serialNumber = $("#serialNumber_" + id).text();
                        isUniqueItem = true;
                    }
                    orderProducts.push({
                        ProductId: productId,
                        ProductName: $(this).data("productname"),
                        TransactionType: 1,
                        Quantity: parseFloat($("#odrQuantity_" + id).text()).toFixed(2),
                        PerItemPrice: parseFloat($("#perItemPrice_" + id).text()).toFixed(2),
                        PerItemTotalPrice: ($("#divPerItemTotalPrice_" + id).length == 1 ? parseFloat($("#divPerItemTotalPrice_" + id).text()) : 0),
                        Price: parseFloat($("#price_" + id).text()).toFixed(2),
                        //Discount
                        Discount: ($("#discount_" + id).length == 1 ? parseFloat($("#discount_" + id).text()) : 0),
                        DiscType: ($("#discount_" + id).length == 1 ? parseInt($("#discount_" + id).data("disctype")) : 0),
                        DiscountAmount: ($("#discPerUnit_" + id).length == 1 ? parseFloat($("#discPerUnit_" + id).text()) : 0),
                        //Coupon Discount
                        CouponDiscount: ($("#couponDiscount_" + id).length == 1 ? parseFloat($("#couponDiscount_" + id).text()) : 0),
                        CouponDiscType: ($("#couponDiscount_" + id).length == 1 ? parseInt($("#couponDiscount_" + id).data("disctype")) : 0),
                        CouponDiscAmount: ($("#CouponDiscPerUnit_" + id).length == 1 ? parseFloat($("#CouponDiscPerUnit_" + id).text()) : 0),
                        SubOfferId: ($("#couponDiscount_" + id).length == 1 ? parseInt($("#couponDiscount_" + id).data("subofferid")) : 0),
                        IsBorrow: isBorrow,
                        IsAfterSaleService: isAfterSaleService,
                        ServiceDays: serviceDays,
                        ServiceName: serviceName,
                        IsPointBased: isPointBased,
                        Points: points,
                        IsUniqueItem: isUniqueItem,
                        SerialNumber: serialNumber
                    });
                }
            });

            invoiceDiscount = 0;
            tax = 0;
            deliveryCharge = 0;
            if (orderAmount > totalPrice) {
                invoiceDiscount = orderAmount - totalPrice;
            }

            if ($("#taxAmount").length == 1) {
                tax = parseFloat($("#taxAmount").text());
            }

            if ($("#divDeliveryCharge").length == 1) {
                deliveryCharge = parseFloat($("#divDeliveryCharge").text());
            }

            var model =
            {
                OrderAmount: orderAmount.toFixed(2),
                DiscountItem: parseFloat($("#divDiscItemTotal").text()).toFixed(2),
                SubTotalPrice: parseFloat($("#divSubTotal").text()).toFixed(2),
                SubTotalBeforeDiscount: ($("#subTotalBeforeDisc").length == 1 ? parseFloat($("#subTotalBeforeDisc").text()).toFixed(2) : 0),
                //Discount
                Discount: ($("#divDiscountAmount").length == 1 && parseInt($("#divDiscountAmount").data("disctype")) == 1 ? parseFloat($("#divDiscountAmount").text()).toFixed(2) : 0),
                DiscType: ($("#divDiscountAmount").length == 1 ? parseInt($("#divDiscountAmount").data("disctype")) : 0),
                DiscountPercent: ($("#divDiscountAmount").length == 1 && parseInt($("#divDiscountAmount").data("disctype")) == 0 ? parseFloat($("#divDiscountAmount").text()).toFixed(2) : 0),
                DiscountAmount: ($("#divDiscValue").length == 1 ? parseFloat($("#divDiscValue").text()) : 0),
                DiscountWorkAmount: ($("#divInvoiceDiscount").length == 1 ? parseFloat($("#divInvoiceDiscount").text()) : 0),
                //Coupon Discount
                CouponDiscount: ($("#divCouponDiscAmount").length == 1 && parseInt($("#divCouponDiscAmount").data("disctype")) == 1 ? parseFloat($("#divCouponDiscAmount").text()).toFixed(2) : 0),
                CouponDiscType: ($("#divCouponDiscAmount").length == 1 ? parseInt($("#divCouponDiscAmount").data("disctype")) : 0),
                CouponDiscPercent: ($("#divCouponDiscAmount").length == 1 && parseInt($("#divCouponDiscAmount").data("disctype")) == 0 ? parseFloat($("#divCouponDiscAmount").text()).toFixed(2) : 0),
                CouponDiscountAmount: ($("#divCouponDiscValue").length == 1 ? parseFloat($("#divCouponDiscValue").text()) : 0),
                CouponDiscWorkAmount: ($("#divCouponInvoiceDiscount").length == 1 ? parseFloat($("#divCouponInvoiceDiscount").text()) : 0),
                //Tax
                Tax: tax,
                TaxPercent: taxRate,
                TotalPrice: parseFloat($("#divTotalAmount").text()).toFixed(2),
                //Delivery Charge
                DeliveryCharge: deliveryCharge.toFixed(2),
                DelChargeType: ($("#divdelChargeType").length == 1 ? parseInt($("#divdelChargeType").data("delchargetype")) : 0),
                DeliveryChargeAmount: ($("#divdelChargeType").length == 1 && parseInt($("#divdelChargeType").data("delchargetype")) == 1 ? parseFloat($("#divDeliveryChargeAmount").text()).toFixed(2) : 0),
                DeliveryChargePercent: ($("#divdelChargeType").length == 1 && parseInt($("#divdelChargeType").data("delchargetype")) == 0 ? parseFloat($("#divDeliveryChargeAmount").text()).toFixed(2) : 0),
                DelChargeBeforeDisc: ($("#deliveryChargeBeforeDisc").length == 1 ? parseFloat($("#deliveryChargeBeforeDisc").text()).toFixed(2) : 0),
                //Delivery Charge Discount
                DelChargeDiscPercent: ($("#divDelChargeDiscPercent").length == 1 ? parseInt($("#divDelChargeDiscPercent").text()) : 0),
                DeliveryChargeDiscount: ($("#divDelChargeDiscount").length == 1 ? parseFloat($("#divDelChargeDiscount").text()) : 0),
                //Coupon Delivery charge discount
                CouponDelChargeDiscPercent: ($("#divCouponDelChargeDiscPercent").length == 1 ? parseInt($("#divCouponDelChargeDiscPercent").text()) : 0),
                CouponDelChargeDiscount: ($("#divCouponDelChargeDiscount").length == 1 ? parseFloat($("#divCouponDelChargeDiscount").text()) : 0),

                InvoiceAmount: parseFloat($("#divInvoiceAmount").text()).toFixed(2),

                OrderProducts: orderProducts,
                //coupon
                OfferId: ($("#divCouponRow").length == 1 ? parseInt($("#divCouponRow").data("offerid")) : 0),
                Coupon: ($("#divCouponRow").length == 1 ? $("#divCouponRow").data("coupon") : ''),
                OfferName: ($("#divCouponRow").length == 1 ? $("#divCouponRow").data("offername") : ''),
            };
            $("#divInvoiceInfo").kendoWindow({
                actions: ["Close"],
                draggable: false,
                modal: true,
                visible: false,
                width: 680,
                height: 695,
                title: 'Invoice Details',
                //resizable: false,
                close: onWindowClose
            });
            var invoiceInfo = $("#divInvoiceInfo").data("kendoWindow");
            invoiceInfo.refresh({ url: '/PointOfSale/InvoiceInfo', type: "POST", data: model });
            invoiceInfo.center().open();
            document.documentElement.style.overflow = 'hidden';  // firefox, chrome
            document.body.scroll = "no";
        }
    });
</script>