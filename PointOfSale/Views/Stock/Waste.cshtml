@{
    ViewBag.Title = "Waste";
    Layout = "~/Views/Shared/_LayoutForTemplate.cshtml";
}
<style>
    input[type=number] {
        width: 100%;
        max-width:100%;
        padding-left:8px;
    }
</style>

<section class="content">
    <div class="panel panel-info">
        <div class="panel-heading" style="padding-bottom:46px;">
            <div class="pull-left">
                <h4 class="uppercase">Waste Create</h4>
            </div>
        </div>
        <div class="panel-body">
            <div class="row">
                <div class="col-md-12">
                    <div class="productAutocomplete">
                        @(Html.Kendo().AutoComplete()
                            .Name("productsAutoComplete")
                            .Placeholder("Type product name...")
                            .HtmlAttributes(new { style = "width:100%; max-width:100%" })
                            .MinLength(3)
                            .DataTextField("Text")
                            .Filter("contains")
                            .DataSource(source =>
                            {
                                source.Read(read =>
                                {
                                    read.Action("GetProductListForText", "PointOfSale")
                                       .Data("additionInfo");
                                })
                               .ServerFiltering(true);
                            })
                            .Events(e =>
                            {
                                e.Change("onChange").Select("onSelect");
                            })
                        )
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div id="divWasteList" style="width:100%!important; margin-top:10px;">
                        <table class="table table-bordered" id="wasteTbl">
                            <tr>
                                <th bgcolor="#cacdd1">Product Name</th>
                                <th width="40%">Quantity</th>
                                <th></th>
                            </tr>
                            <tr id="emptyRow">
                                <td colspan="3">
                                    <h3>There is no product</h3>
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <label for="comment">Comment:</label>
                    <textarea class="form-control" rows="3" cols="30" id="comment" style="max-width:100%; margin-bottom:10px;"></textarea>
                </div>
                <div class="col-md-12">
                    <button class="btn btn-primary pull-right" id="btnWasteProductSave">Save</button>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
    var rowId = 0;
    var validation;
    $(document).ready(function () {
        $("#liForInventory").addClass('active');
        $("#liForWasteHistory").addClass('active');

        $("#btnWasteProductSave").prop('disabled', true);
        validation = $("#divWasteList").kendoValidator().data("kendoValidator");
    });
    function onChange() {
        $("#productsAutoComplete").data("kendoAutoComplete").value("");
    }
    function onSelect(e) {
        rowId = this.dataItem(e.item.index()).Value;
        $.ajax({
                url: '@Url.Action("GetProduct", "PointOfSale")',
                type: 'Get',
                data: { rowId: rowId },
                success: function (data)
                {
                    if (data == "error")
                    {
                        alert("Not Found...");
                    }
                    else
                    {
                        $("#btnWasteProductSave").prop('disabled', false);
                        if ($("#emptyRow").length == 1) {
                            $("#emptyRow").hide();
                        }
                        if ($("#waste_" + rowId).length == 1) {
                            alert("This product already add to waste list")
                        }
                        else {
                            $("#wasteTbl").append('<tr id="waste_' + rowId + '" class="wasteItem" data-rowid="' + rowId + '" data-productid="' + data.ProductId + '" data-distributeid="' + data.DistributeId + '">' +
                                '<td>' + data.ProductName + '</td>' +
                                '<td>' +
                                '<input type="number" min="0" class="k-input" id="quantity_' + rowId + '" name="quantity_' + rowId + '" data-id="' + rowId + '" data-val-required="*"/>' +
                                '<span class="field-validation-valid text-danger" data-valmsg-for="quantity_' + rowId + '" data-valmsg-replace="true"></span>' +
                                '</td>' +
                                '<td>' +
                                '<span id="btnCancelProduct" data-id="' + rowId + '"><i class="fa fa-times" aria-hidden="true" style="font-size:24px;cursor:pointer"></i></span>' +
                                '</td>' +
                                '</tr> ');
                        }
                    }
                },
                error: function() {
                    alert("Not Found...");
                    $("#productsAutoComplete").data("kendoAutoComplete").value("");
                }
        });
        //$("#divImportList").load('@Url.Action("ImportPartial","Stock")?ImportIds=' + productId);
    }
    function additionInfo()
    {
        var ids = [];
        $(".wasteItem").each(function () {
            ids.push($(this).data("rowid"));
        });
        return {
            ids: ids.join(","),
            text: $("#productsAutoComplete").val()
        }
    }
    //******************cancel product from waste list
    $("#wasteTbl").on('click', '#btnCancelProduct', function () {
        rowId = $(this).data("id");
        $("#waste_" + rowId).remove();
        if ($("#wasteTbl tr").length == 2) {
            $("#btnWasteProductSave").prop('disabled', true);
            $("#emptyRow").show();
        }
    });

    //*********************Waste product save ***************
    $("#btnWasteProductSave").click(function () {
        if (validation.validate())
        {
            var wasteData = [];
            $(".wasteItem").each(function () {
                rowId = $(this).data("rowid");
                wasteData.push({
                    ProductId: $(this).data("productid"),
                    DistributeId: $(this).data("distributeid"),
                    Quantity: $("#quantity_" + rowId).val(),
                });
            });
            $.ajax({
                url: '@Url.Action("WasteSave", "Stock")',
                type: 'POST',
                data: JSON.stringify({ UserId: userId, WasteData: wasteData, Comments: $("#comment").val() }),
                contentType: 'application/json',
                success: function (data) {
                    if (data == "success") {
                        window.location.reload();
                    }
                    else {
                        alert("Import error...");
                    }
                }
            });
        }
    });

    @*$("#productAutocomplete").ready(function () {
         $("#searchProduct").kendoAutoComplete({
            filter: "contains",
            placeholder: "Search by product name...",
            minLength: 3,
            // JSON property name to use
            dataSource: new kendo.data.DataSource({
                transport: {
                    read: {
                        url: '@Url.Action("GetProductListForText", "PointOfSale")',
                        serverPaging: true,
                        pageSize: 20,
                        contentType: 'application/json; charset=utf-8',
                        type: 'GET',
                        dataType: 'json'
                    },
                    serverSorting: true,
                    serverFiltering: true
                }
            }),
            height: 400,
            dataValueField: 'Value',
            dataTextField: "Text",
            select: onSelect,
            change: onChangeText
         });
    });*@

</script>